<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#1f2937">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>AirGit - Git Operations from Mobile</title>
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'><rect fill='%231f2937' width='180' height='180'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' font-size='80' font-weight='bold' fill='%2310b981' font-family='system-ui'>A</text></svg>">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><rect fill='%231f2937' width='32' height='32'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' font-size='24' font-weight='bold' fill='%2310b981' font-family='system-ui'>A</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background-color: #111827;
            color: #f3f4f6;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
        }
        .push-button:active {
            transform: scale(0.98);
        }
        .loading {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .success-animation {
            animation: popIn 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        @keyframes popIn {
            0% { transform: scale(0.5); opacity: 0; }
            50% { opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-50">
    <div class="min-h-screen flex flex-col">
        <!-- Header -->
        <header class="bg-gray-800 border-b border-gray-700 px-4 py-4 safe-area-inset-top">
            <div class="max-w-sm mx-auto">
                <div class="flex justify-between items-start mb-2">
                    <h1 class="text-xl font-bold text-emerald-400" id="repo-name">AirGit</h1>
                    <div class="flex gap-2">
                        <button id="branch-selector-btn" class="text-xs bg-gray-700 hover:bg-gray-600 px-2 py-1 rounded text-gray-300">Branch</button>
                        <button id="remotes-selector-btn" class="text-xs bg-gray-700 hover:bg-gray-600 px-2 py-1 rounded text-gray-300">Remotes</button>
                        <button id="repo-selector-btn" class="text-xs bg-gray-700 hover:bg-gray-600 px-2 py-1 rounded text-gray-300">Repos</button>
                    </div>
                </div>
                <div class="text-sm text-gray-400 space-y-1">
                    <div>Branch: <span id="branch-name" class="font-mono text-gray-200">Loading...</span></div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-1 flex items-center justify-center px-4 py-8 safe-area-inset-bottom">
            <div class="w-full max-w-sm">
                <!-- Status Alert -->
                <div id="status-container" class="mb-6 hidden"></div>

                <!-- Push Button -->
                <div class="flex justify-center gap-6">
                    <button id="push-button" class="push-button w-32 h-32 rounded-full bg-emerald-500 hover:bg-emerald-600 text-white font-bold text-xl shadow-lg transition-all duration-200 active:shadow-inner focus:outline-none focus:ring-4 focus:ring-emerald-300 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center">
                        <span id="button-text">PUSH</span>
                        <svg id="loading-spinner" class="loading hidden w-8 h-8" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </button>
                    <button id="pull-button" class="push-button w-32 h-32 rounded-full bg-blue-500 hover:bg-blue-600 text-white font-bold text-xl shadow-lg transition-all duration-200 active:shadow-inner focus:outline-none focus:ring-4 focus:ring-blue-300 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center">
                        <span id="pull-button-text">PULL</span>
                        <svg id="pull-loading-spinner" class="loading hidden w-8 h-8" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </button>
                </div>

                <!-- Success Message -->
                <div id="success-message" class="hidden mt-8 text-center success-animation">
                    <div class="text-5xl mb-3">âœ“</div>
                    <div class="text-2xl font-bold text-emerald-400">Success!</div>
                    <div class="text-sm text-gray-400 mt-2">Pushed to origin</div>
                    <button id="close-success-btn" class="mt-4 bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded text-gray-200 text-sm">Close</button>
                </div>

                <!-- Error Message -->
                <div id="error-message" class="hidden mt-8 p-4 bg-red-900/30 border border-red-700 rounded-lg text-red-300 text-sm">
                </div>

                <!-- Log Output -->
                <div id="log-container" class="hidden mt-6">
                    <div class="text-xs text-gray-500 mb-2">Log Output:</div>
                    <div id="log-output" class="bg-gray-800 border border-gray-700 rounded p-3 max-h-48 overflow-y-auto font-mono text-xs text-gray-300">
                    </div>
                </div>
            </div>
        </main>

        <!-- Branch Selector Modal -->
        <div id="branch-modal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4 safe-area-inset-bottom">
            <div class="bg-gray-800 rounded-lg p-6 w-full max-w-sm max-h-96 flex flex-col border border-gray-700">
                <h2 class="text-lg font-bold text-emerald-400 mb-4">Select Branch</h2>
                <div id="branches-list" class="flex-1 overflow-y-auto space-y-2 mb-4">
                    <div class="text-center text-gray-400 text-sm">Loading...</div>
                </div>
                <button id="branch-modal-close-btn" class="w-full bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded text-gray-200 text-sm">Close</button>
            </div>
        </div>

        <!-- Repository Selector Modal -->
        <div id="repo-modal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4 safe-area-inset-bottom">
            <div class="bg-gray-800 rounded-lg p-6 w-full max-w-sm max-h-96 flex flex-col border border-gray-700">
                <h2 class="text-lg font-bold text-emerald-400 mb-4">Select Repository</h2>
                <div id="repos-list" class="flex-1 overflow-y-auto space-y-2 mb-4">
                    <div class="text-center text-gray-400 text-sm">Loading...</div>
                </div>
                <button id="create-repo-btn" class="w-full bg-emerald-600 hover:bg-emerald-500 px-4 py-2 rounded text-white text-sm font-medium mb-2 transition-colors">+ New Repository</button>
                <button id="modal-close-btn" class="w-full bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded text-gray-200 text-sm">Close</button>
            </div>
        </div>

        <!-- Create Repository Modal -->
        <div id="create-repo-modal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4 safe-area-inset-bottom">
            <div class="bg-gray-800 rounded-lg p-6 w-full max-w-sm border border-gray-700">
                <h2 class="text-lg font-bold text-emerald-400 mb-4">Create New Repository</h2>
                <div class="space-y-4 mb-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Repository Name</label>
                        <input id="create-repo-name" type="text" placeholder="my-repo" class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-gray-100 placeholder-gray-500 text-sm focus:outline-none focus:border-emerald-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Subdirectories (optional)</label>
                        <input id="create-repo-subdirs" type="text" placeholder="src,tests,docs" class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-gray-100 placeholder-gray-500 text-sm focus:outline-none focus:border-emerald-500">
                        <div class="text-xs text-gray-500 mt-1">Comma-separated list</div>
                    </div>
                </div>
                <div id="create-repo-error" class="hidden mb-4 p-3 bg-red-900/30 border border-red-700 rounded text-red-300 text-sm"></div>
                <div class="flex gap-2">
                    <button id="create-repo-submit" class="flex-1 bg-emerald-600 hover:bg-emerald-500 px-4 py-2 rounded text-white text-sm font-medium transition-colors">Create</button>
                    <button id="create-repo-close-btn" class="flex-1 bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded text-gray-200 text-sm">Cancel</button>
                </div>
            </div>
        </div>

        <!-- Remotes Management Modal -->
        <div id="remotes-modal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4 safe-area-inset-bottom">
            <div class="bg-gray-800 rounded-lg p-6 w-full max-w-sm max-h-96 flex flex-col border border-gray-700">
                <h2 class="text-lg font-bold text-emerald-400 mb-4">Manage Remotes</h2>
                <div id="remotes-list" class="flex-1 overflow-y-auto space-y-2 mb-4">
                    <div class="text-center text-gray-400 text-sm">Loading...</div>
                </div>
                <button id="add-remote-btn" class="w-full bg-emerald-600 hover:bg-emerald-500 px-4 py-2 rounded text-white text-sm font-medium mb-2 transition-colors">+ Add Remote</button>
                <button id="remotes-modal-close-btn" class="w-full bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded text-gray-200 text-sm">Close</button>
            </div>
        </div>

        <!-- Add/Edit Remote Modal -->
        <div id="remote-form-modal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4 safe-area-inset-bottom">
            <div class="bg-gray-800 rounded-lg p-6 w-full max-w-sm border border-gray-700">
                <h2 id="remote-form-title" class="text-lg font-bold text-emerald-400 mb-4">Add Remote</h2>
                <div class="space-y-4 mb-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Remote Name</label>
                        <input id="remote-name-input" type="text" placeholder="origin" class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-gray-100 placeholder-gray-500 text-sm focus:outline-none focus:border-emerald-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Repository URL</label>
                        <input id="remote-url-input" type="text" placeholder="https://github.com/user/repo.git" class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-gray-100 placeholder-gray-500 text-sm focus:outline-none focus:border-emerald-500">
                    </div>
                </div>
                <div id="remote-form-error" class="hidden mb-4 p-3 bg-red-900/30 border border-red-700 rounded text-red-300 text-sm"></div>
                <div class="flex gap-2">
                    <button id="remote-form-submit" class="flex-1 bg-emerald-600 hover:bg-emerald-500 px-4 py-2 rounded text-white text-sm font-medium transition-colors">Save</button>
                    <button id="remote-form-close-btn" class="flex-1 bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded text-gray-200 text-sm">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/service-worker.js').catch(() => {});
        }

        const pushButton = document.getElementById('push-button');
        const pullButton = document.getElementById('pull-button');
        const buttonText = document.getElementById('button-text');
        const pullButtonText = document.getElementById('pull-button-text');
        const loadingSpinner = document.getElementById('loading-spinner');
        const pullLoadingSpinner = document.getElementById('pull-loading-spinner');
        const statusContainer = document.getElementById('status-container');
        const successMessage = document.getElementById('success-message');
        const closeSuccessBtn = document.getElementById('close-success-btn');
        const errorMessage = document.getElementById('error-message');
        const logContainer = document.getElementById('log-container');
        const logOutput = document.getElementById('log-output');
        console.log('Elements loaded:', { pushButton, pullButton, logContainer, logOutput });
        const branchName = document.getElementById('branch-name');
        const repoName = document.getElementById('repo-name');
        const branchSelectorBtn = document.getElementById('branch-selector-btn');
        const branchModal = document.getElementById('branch-modal');
        const branchesList = document.getElementById('branches-list');
        const branchModalCloseBtn = document.getElementById('branch-modal-close-btn');
        const repoSelectorBtn = document.getElementById('repo-selector-btn');
        const repoModal = document.getElementById('repo-modal');
        const reposList = document.getElementById('repos-list');
        const modalCloseBtn = document.getElementById('modal-close-btn');
        const createRepoBtn = document.getElementById('create-repo-btn');
        const createRepoModal = document.getElementById('create-repo-modal');
        const createRepoNameInput = document.getElementById('create-repo-name');
        const createRepoSubdirsInput = document.getElementById('create-repo-subdirs');
        const createRepoSubmitBtn = document.getElementById('create-repo-submit');
        const createRepoCloseBtn = document.getElementById('create-repo-close-btn');
        const createRepoError = document.getElementById('create-repo-error');
        const remotesSelectorBtn = document.getElementById('remotes-selector-btn');
        const remotesModal = document.getElementById('remotes-modal');
        const remotesList = document.getElementById('remotes-list');
        const remotesModalCloseBtn = document.getElementById('remotes-modal-close-btn');
        const addRemoteBtn = document.getElementById('add-remote-btn');
        const remoteFormModal = document.getElementById('remote-form-modal');
        const remoteFormTitle = document.getElementById('remote-form-title');
        const remoteNameInput = document.getElementById('remote-name-input');
        const remoteUrlInput = document.getElementById('remote-url-input');
        const remoteFormSubmitBtn = document.getElementById('remote-form-submit');
        const remoteFormCloseBtn = document.getElementById('remote-form-close-btn');
        const remoteFormError = document.getElementById('remote-form-error');
        let currentEditingRemote = null;

        function getCurrentRepositoryPath() {
            const pathname = window.location.pathname;
            if (pathname && pathname !== '/') {
                return pathname;
            }
            return null;
        }

        function getCurrentBranch() {
            const params = new URLSearchParams(window.location.search);
            return params.get('b');
        }

        async function loadStatus() {
            try {
                const repoPath = getCurrentRepositoryPath();
                const url = new URL('/api/status', window.location.origin);
                if (repoPath) {
                    url.searchParams.append('repoPath', repoPath);
                }
                const response = await fetch(url.toString());
                const data = await response.json();
                if (response.ok) {
                    branchName.textContent = data.branch || 'unknown';
                    if (data.repoName) {
                        repoName.textContent = data.repoName;
                    }
                } else {
                    branchName.textContent = 'Error';
                }
            } catch (error) {
                branchName.textContent = 'Error';
            }
        }

        async function initializeFromUrl() {
            const repoPath = getCurrentRepositoryPath();
            const branch = getCurrentBranch();

            // If no path and no branch parameter, just load status
            if (!repoPath && !branch) {
                loadStatus();
                return;
            }

            try {
                const url = new URL('/api/load-repo', window.location.origin);
                if (repoPath) url.searchParams.append('p', repoPath);
                if (branch) url.searchParams.append('b', branch);

                const response = await fetch(url.toString());
                const data = await response.json();

                if (response.ok) {
                    branchName.textContent = data.branch || 'unknown';
                    if (data.repoName) {
                        repoName.textContent = data.repoName;
                    }
                } else {
                    branchName.textContent = 'Error';
                    console.error('Load repo error:', data);
                }
            } catch (error) {
                console.error('Load repo failed:', error);
                loadStatus();
            }
        }

        async function loadBranches() {
            try {
                const repoPath = getCurrentRepositoryPath();
                const url = new URL('/api/branches', window.location.origin);
                if (repoPath) {
                    url.searchParams.append('repoPath', repoPath);
                }
                const response = await fetch(url.toString());
                const data = await response.json();
                if (response.ok && data.branches) {
                    displayBranches(data.branches);
                } else if (data.error) {
                    branchesList.innerHTML = `<div class="text-center text-red-400 text-sm">${escapeHtml(data.error)}</div>`;
                } else {
                    branchesList.innerHTML = `<div class="text-center text-red-400 text-sm">Failed to load branches</div>`;
                }
            } catch (error) {
                console.error('Branch load error:', error);
                branchesList.innerHTML = `<div class="text-center text-red-400 text-sm">Connection failed: ${escapeHtml(error.message)}</div>`;
            }
        }

        function displayBranches(branches) {
            if (branches.length === 0) {
                branchesList.innerHTML = '<div class="text-center text-gray-400 text-sm">No branches found</div>';
                return;
            }

            branchesList.innerHTML = branches.map(branch => `
                <button class="w-full text-left bg-gray-700 hover:bg-gray-600 px-4 py-3 rounded text-gray-200 text-sm transition-colors"
                        onclick="checkoutBranch('${escapeHtml(branch)}')">
                    <div class="font-semibold text-emerald-400">${escapeHtml(branch)}</div>
                </button>
            `).join('');
        }

        async function checkoutBranch(branch) {
            try {
                const response = await fetch('/api/checkout', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        branch: branch
                    })
                });
                const data = await response.json();

                if (response.ok) {
                    branchName.textContent = data.branch || 'unknown';
                    branchModal.classList.add('hidden');
                    
                    // Update URL to reflect the new branch
                    const url = new URL(window.location);
                    url.searchParams.set('b', data.branch);
                    window.history.pushState({}, '', url.toString());
                } else {
                    alert(`Error checking out branch: ${data.error || 'Unknown error'}`);
                }
            } catch (error) {
                alert(`Connection error: ${error.message}`);
            }
        }

        async function loadRepositories() {
             try {
                 const response = await fetch('/api/repos');
                 const data = await response.json();
                 if (response.ok && data.repositories) {
                     displayRepositories(data.repositories);
                 } else if (data.error) {
                     reposList.innerHTML = `<div class="text-center text-red-400 text-sm">${escapeHtml(data.error)}</div>`;
                 } else {
                     reposList.innerHTML = `<div class="text-center text-red-400 text-sm">Failed to load repositories</div>`;
                 }
             } catch (error) {
                 console.error('Repository load error:', error);
                 reposList.innerHTML = `<div class="text-center text-red-400 text-sm">Connection failed: ${escapeHtml(error.message)}</div>`;
             }
         }

        function displayRepositories(repos) {
            if (repos.length === 0) {
                reposList.innerHTML = '<div class="text-center text-gray-400 text-sm">No repositories found</div>';
                return;
            }

            reposList.innerHTML = repos.map(repo => `
                <button class="w-full text-left bg-gray-700 hover:bg-gray-600 px-4 py-3 rounded text-gray-200 text-sm transition-colors"
                        onclick="selectRepository('${escapeHtml(repo.name)}', '${escapeHtml(repo.path)}')">
                    <div class="font-semibold text-emerald-400">${escapeHtml(repo.name)}</div>
                    <div class="text-xs text-gray-400 truncate">${escapeHtml(repo.path)}</div>
                </button>
            `).join('');
        }

        async function selectRepository(name, relativePath) {
            try {
                repoModal.classList.add('hidden');
                
                // Navigate to the repository URL with the branch parameter
                const url = new URL(window.location.origin);
                url.pathname = '/' + relativePath;
                window.location.href = url.toString();
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }

        function resetUI() {
            pushButton.disabled = false;
            pullButton.disabled = false;
            buttonText.textContent = 'PUSH';
            pullButtonText.textContent = 'PULL';
            loadingSpinner.classList.add('hidden');
            pullLoadingSpinner.classList.add('hidden');
            buttonText.classList.remove('hidden');
            pullButtonText.classList.remove('hidden');
            successMessage.classList.add('hidden');
            errorMessage.classList.add('hidden');
            logContainer.classList.add('hidden');
            statusContainer.classList.add('hidden');
        }

        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.classList.remove('hidden');
        }

        function showLog(lines) {
            try {
                console.log('showLog called with lines:', lines);
                logContainer.style.display = 'block';  // Force display
                logContainer.classList.remove('hidden');
                logOutput.innerHTML = '';
                if (Array.isArray(lines)) {
                    lines.forEach(line => {
                        const div = document.createElement('div');
                        div.textContent = line;
                        logOutput.appendChild(div);
                    });
                }
                logOutput.scrollTop = logOutput.scrollHeight;
                console.log('showLog completed');
            } catch (error) {
                console.error('showLog error:', error);
                logContainer.classList.remove('hidden');
                logOutput.textContent = 'Error displaying log';
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        branchSelectorBtn.addEventListener('click', async () => {
            branchModal.classList.remove('hidden');
            loadBranches();
        });

        branchModalCloseBtn.addEventListener('click', () => {
            branchModal.classList.add('hidden');
        });

        branchModal.addEventListener('click', (e) => {
            if (e.target === branchModal) {
                branchModal.classList.add('hidden');
            }
        });

        repoSelectorBtn.addEventListener('click', () => {
            repoModal.classList.remove('hidden');
            loadRepositories();
        });

        modalCloseBtn.addEventListener('click', () => {
            repoModal.classList.add('hidden');
        });

        repoModal.addEventListener('click', (e) => {
            if (e.target === repoModal) {
                repoModal.classList.add('hidden');
            }
        });

        createRepoBtn.addEventListener('click', () => {
            repoModal.classList.add('hidden');
            createRepoModal.classList.remove('hidden');
            createRepoNameInput.value = '';
            createRepoSubdirsInput.value = '';
            createRepoError.classList.add('hidden');
            createRepoNameInput.focus();
        });

        createRepoCloseBtn.addEventListener('click', () => {
            createRepoModal.classList.add('hidden');
        });

        remotesSelectorBtn.addEventListener('click', async () => {
            remotesModal.classList.remove('hidden');
            loadRemotes();
        });

        remotesModalCloseBtn.addEventListener('click', () => {
            remotesModal.classList.add('hidden');
        });

        remotesModal.addEventListener('click', (e) => {
            if (e.target === remotesModal) {
                remotesModal.classList.add('hidden');
            }
        });

        addRemoteBtn.addEventListener('click', () => {
            remotesModal.classList.add('hidden');
            openAddRemoteForm();
        });

        remoteFormCloseBtn.addEventListener('click', () => {
            remoteFormModal.classList.add('hidden');
        });

        remoteFormModal.addEventListener('click', (e) => {
            if (e.target === remoteFormModal) {
                remoteFormModal.classList.add('hidden');
            }
        });

        remoteFormSubmitBtn.addEventListener('click', saveRemote);

        createRepoModal.addEventListener('click', (e) => {
            if (e.target === createRepoModal) {
                createRepoModal.classList.add('hidden');
            }
        });

        createRepoSubmitBtn.addEventListener('click', async () => {
            const repoName = createRepoNameInput.value.trim();
            const subdirs = createRepoSubdirsInput.value.trim();

            if (!repoName) {
                showCreateRepoError('Repository name is required');
                return;
            }

            createRepoSubmitBtn.disabled = true;
            createRepoSubmitBtn.textContent = 'Creating...';
            createRepoError.classList.add('hidden');

            try {
                const response = await fetch('/api/repo/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        repoName: repoName,
                        subdirs: subdirs || ''
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    createRepoModal.classList.add('hidden');
                    createRepoSubmitBtn.disabled = false;
                    createRepoSubmitBtn.textContent = 'Create';
                    
                    // Reload repositories and show success
                    repoModal.classList.remove('hidden');
                    loadRepositories();
                    
                    // Show success message with logs
                    showLog(data.log || ['Repository created successfully']);
                } else {
                    showCreateRepoError(data.error || 'Failed to create repository');
                    createRepoSubmitBtn.disabled = false;
                    createRepoSubmitBtn.textContent = 'Create';
                }
            } catch (error) {
                showCreateRepoError('Network error: ' + error.message);
                createRepoSubmitBtn.disabled = false;
                createRepoSubmitBtn.textContent = 'Create';
            }
        });

        function showCreateRepoError(message) {
            createRepoError.textContent = message;
            createRepoError.classList.remove('hidden');
        }

        async function loadRemotes() {
            try {
                const repoPath = getCurrentRepositoryPath();
                const url = new URL('/api/remotes', window.location.origin);
                if (repoPath) {
                    url.searchParams.append('repoPath', repoPath);
                }
                const response = await fetch(url.toString());
                const data = await response.json();
                if (response.ok && data.remotes) {
                    displayRemotes(data.remotes);
                } else if (data.error) {
                    remotesList.innerHTML = `<div class="text-center text-red-400 text-sm">${escapeHtml(data.error)}</div>`;
                } else {
                    remotesList.innerHTML = `<div class="text-center text-red-400 text-sm">Failed to load remotes</div>`;
                }
            } catch (error) {
                console.error('Remotes load error:', error);
                remotesList.innerHTML = `<div class="text-center text-red-400 text-sm">Connection failed: ${escapeHtml(error.message)}</div>`;
            }
        }

        function displayRemotes(remotes) {
            if (remotes.length === 0) {
                remotesList.innerHTML = '<div class="text-center text-gray-400 text-sm">No remotes configured</div>';
                return;
            }

            remotesList.innerHTML = remotes.map(remote => `
                <div class="bg-gray-700 rounded px-4 py-3 text-gray-200 text-sm flex justify-between items-center">
                    <div class="flex-1">
                        <div class="font-semibold text-emerald-400">${escapeHtml(remote.name)}</div>
                        <div class="text-xs text-gray-400 truncate">${escapeHtml(remote.url)}</div>
                    </div>
                    <div class="flex gap-2 ml-2">
                        <button class="text-xs bg-blue-600 hover:bg-blue-500 px-2 py-1 rounded text-white transition-colors"
                                onclick="editRemote('${escapeHtml(remote.name)}', '${escapeHtml(remote.url)}')">Edit</button>
                        <button class="text-xs bg-red-600 hover:bg-red-500 px-2 py-1 rounded text-white transition-colors"
                                onclick="removeRemote('${escapeHtml(remote.name)}')">Remove</button>
                    </div>
                </div>
            `).join('');
        }

        function openAddRemoteForm() {
            currentEditingRemote = null;
            remoteFormTitle.textContent = 'Add Remote';
            remoteNameInput.value = '';
            remoteUrlInput.value = '';
            remoteFormError.classList.add('hidden');
            remoteFormSubmitBtn.textContent = 'Add';
            remoteNameInput.disabled = false;
            remoteFormModal.classList.remove('hidden');
            remoteNameInput.focus();
        }

        function editRemote(name, url) {
            currentEditingRemote = name;
            remoteFormTitle.textContent = 'Edit Remote';
            remoteNameInput.value = name;
            remoteUrlInput.value = url;
            remoteFormError.classList.add('hidden');
            remoteFormSubmitBtn.textContent = 'Update';
            remoteNameInput.disabled = true;
            remoteFormModal.classList.remove('hidden');
            remoteUrlInput.focus();
        }

        async function removeRemote(name) {
            if (!confirm(`Are you sure you want to remove the remote "${name}"?`)) {
                return;
            }

            try {
                const repoPath = getCurrentRepositoryPath();
                const url = new URL('/api/remote/remove', window.location.origin);
                if (repoPath) {
                    url.searchParams.append('repoPath', repoPath);
                }
                const response = await fetch(url.toString(), {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: name })
                });

                const data = await response.json();

                if (response.ok) {
                    loadRemotes();
                } else {
                    alert(`Error: ${data.error || 'Failed to remove remote'}`);
                }
            } catch (error) {
                alert(`Connection error: ${error.message}`);
            }
        }

        async function saveRemote() {
            const name = remoteNameInput.value.trim();
            const url = remoteUrlInput.value.trim();

            if (!name || !url) {
                remoteFormError.textContent = 'Remote name and URL are required';
                remoteFormError.classList.remove('hidden');
                return;
            }

            remoteFormSubmitBtn.disabled = true;
            const originalText = remoteFormSubmitBtn.textContent;
            remoteFormSubmitBtn.textContent = 'Saving...';
            remoteFormError.classList.add('hidden');

            try {
                const repoPath = getCurrentRepositoryPath();
                let endpoint = '/api/remote/add';
                if (currentEditingRemote) {
                    endpoint = '/api/remote/update';
                }

                const apiUrl = new URL(endpoint, window.location.origin);
                if (repoPath) {
                    apiUrl.searchParams.append('repoPath', repoPath);
                }

                const response = await fetch(apiUrl.toString(), {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: name, url: url })
                });

                const data = await response.json();

                if (response.ok) {
                    remoteFormModal.classList.add('hidden');
                    remoteFormSubmitBtn.disabled = false;
                    remoteFormSubmitBtn.textContent = originalText;
                    loadRemotes();
                } else {
                    remoteFormError.textContent = data.error || 'Failed to save remote';
                    remoteFormError.classList.remove('hidden');
                    remoteFormSubmitBtn.disabled = false;
                    remoteFormSubmitBtn.textContent = originalText;
                }
            } catch (error) {
                remoteFormError.textContent = 'Network error: ' + error.message;
                remoteFormError.classList.remove('hidden');
                remoteFormSubmitBtn.disabled = false;
                remoteFormSubmitBtn.textContent = originalText;
            }
        }

        closeSuccessBtn.addEventListener('click', () => {
            successMessage.classList.add('hidden');
            resetUI();
        });

        pushButton.addEventListener('click', async () => {
            console.log('PUSH button clicked');
            pushButton.disabled = true;
            pullButton.disabled = true;
            buttonText.classList.add('hidden');
            loadingSpinner.classList.remove('hidden');
            successMessage.classList.add('hidden');
            errorMessage.classList.add('hidden');
            logContainer.classList.add('hidden');

            try {
                const repoPath = getCurrentRepositoryPath();
                const url = new URL('/api/push', window.location.origin);
                if (repoPath) {
                    url.searchParams.append('repoPath', repoPath);
                }
                const response = await fetch(url.toString(), { method: 'POST' });
                const data = await response.json();

                if (response.ok) {
                    console.log('PUSH: response.ok is true, data:', data);
                    loadingSpinner.classList.add('hidden');
                    successMessage.classList.remove('hidden');
                    console.log('PUSH: success message should be visible now');
                    showLog(data.log || ['Push completed']);
                    loadStatus();
                } else {
                    console.log('PUSH: response failed with status', response.status, 'data:', data);
                    loadingSpinner.classList.add('hidden');
                    successMessage.classList.remove('hidden');
                    showError(data.error || 'Push failed');
                    showLog(data.log || []);
                    loadStatus();
                }
            } catch (error) {
                console.error('Push error:', error);
                showError('Network error: ' + error.message);
                resetUI();
            }
        });

        pullButton.addEventListener('click', async () => {
            pushButton.disabled = true;
            pullButton.disabled = true;
            pullButtonText.classList.add('hidden');
            pullLoadingSpinner.classList.remove('hidden');
            successMessage.classList.add('hidden');
            errorMessage.classList.add('hidden');
            logContainer.classList.add('hidden');

            try {
                const repoPath = getCurrentRepositoryPath();
                const url = new URL('/api/pull', window.location.origin);
                if (repoPath) {
                    url.searchParams.append('repoPath', repoPath);
                }
                const response = await fetch(url.toString(), { method: 'POST' });
                const data = await response.json();

                if (response.ok) {
                    pullLoadingSpinner.classList.add('hidden');
                    successMessage.classList.remove('hidden');
                    if (data.log) {
                        showLog(data.log);
                    }
                    loadStatus();
                } else {
                    showError(data.error || 'Pull failed');
                    if (data.log) {
                        showLog(data.log);
                    }
                    resetUI();
                }
            } catch (error) {
                showError('Network error: ' + error.message);
                resetUI();
            }
        });

        initializeFromUrl();
        setInterval(loadStatus, 5000);
    </script>
</body>
</html>
