<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="theme-color" content="#0ea5e9">
    <meta name="description" content="Push and pull Git changes from your mobile device">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="AirGit">
    <title>AirGit - Git Operations from Mobile</title>
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/icon.png">
    <link rel="icon" href="/icon.png" type="image/png">
    <meta name="mobile-web-app-capable" content="yes">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body {
            background-color: #ffffff;
            color: #1f2937;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
        }
        .push-button:active {
            transform: scale(0.98);
        }
        .loading {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .success-animation {
            animation: popIn 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        @keyframes popIn {
            0% { transform: scale(0.5); opacity: 0; }
            50% { opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }
    </style>
</head>
<body class="bg-white text-gray-900">
    <div class="min-h-screen flex flex-col pb-24">
        <!-- Header -->
        <header class="bg-sky-50 border-b border-sky-200 px-4 py-4 safe-area-inset-top">
            <div class="max-w-sm mx-auto">
                <div class="flex justify-between items-start mb-2">
                    <h1 class="text-xl font-bold text-sky-600" id="repo-name">AirGit</h1>
                    <button id="settings-btn" class="flex items-center justify-center w-10 h-10 rounded-lg text-gray-600 hover:text-sky-600 hover:bg-sky-100 transition-all duration-200">
                        <i class="fas fa-pen-to-square text-lg"></i>
                    </button>
                </div>
                <div class="text-sm text-gray-600 space-y-1">
                    <div>Branch: <span id="branch-name" class="font-mono text-gray-700">Loading...</span></div>
                    <div id="tracking-info" class="text-xs text-gray-500 mt-1 hidden">
                        <span id="ahead-behind-status"></span>
                    </div>
                </div>
            </div>
        </header>

        <!-- Bottom Navigation Menu -->
        <nav class="fixed bottom-0 left-0 right-0 bg-sky-50 border-t border-sky-200 px-4 py-2 safe-area-inset-bottom">
            <div class="max-w-sm mx-auto flex justify-around items-center">
                <button id="repo-selector-btn" class="flex flex-col items-center gap-1 px-4 py-3 rounded text-gray-600 hover:text-sky-600 hover:bg-sky-100 transition-all duration-200">
                    <i class="fas fa-hard-drive text-lg"></i>
                    <span class="text-xs font-medium">Repos</span>
                </button>
                <button id="branch-selector-btn" class="flex flex-col items-center gap-1 px-4 py-3 rounded text-gray-600 hover:text-sky-600 hover:bg-sky-100 transition-all duration-200">
                    <i class="fas fa-folder-open text-lg"></i>
                    <span class="text-xs font-medium">Branch</span>
                </button>
                <button id="remotes-selector-btn" class="flex flex-col items-center gap-1 px-4 py-3 rounded text-gray-600 hover:text-sky-600 hover:bg-sky-100 transition-all duration-200">
                    <i class="fas fa-cloud text-lg"></i>
                    <span class="text-xs font-medium">Remotes</span>
                </button>
                <button id="tags-btn" class="flex flex-col items-center gap-1 px-4 py-3 rounded text-gray-600 hover:text-sky-600 hover:bg-sky-100 transition-all duration-200">
                    <i class="fas fa-tags text-lg"></i>
                    <span class="text-xs font-medium">Tags</span>
                </button>
                <button id="commits-btn" class="flex flex-col items-center gap-1 px-4 py-3 rounded text-gray-600 hover:text-sky-600 hover:bg-sky-100 transition-all duration-200">
                    <i class="fas fa-clock text-lg"></i>
                    <span class="text-xs font-medium">Log</span>
                </button>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col px-4 py-4 safe-area-inset-bottom overflow-hidden">
            <div class="w-full max-w-sm mx-auto flex-1 flex flex-col overflow-hidden">
                <!-- Status Alert -->
                <div id="status-container" class="mb-4 hidden"></div>

                <!-- Issues Panel -->
                <div id="issues-panel" class="flex-1 flex flex-col mb-4 bg-sky-50 border border-sky-200 rounded-lg p-4 overflow-hidden">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="text-sm font-bold text-sky-600">ðŸ“‹ Issues</h3>
                        <div class="flex gap-2">
                            <button id="create-issue-btn" class="bg-green-500 hover:bg-green-600 text-white px-2 py-1 rounded text-xs transition-colors" title="Create new issue">+ New</button>
                            <button id="view-toggle-btn" class="bg-gray-500 hover:bg-gray-600 text-white px-2 py-1 rounded text-xs transition-colors" title="Toggle view">View: Issues</button>
                            <button id="issues-refresh-btn" class="bg-sky-500 hover:bg-sky-600 text-white px-2 py-1 rounded text-xs transition-colors" title="Refresh">ðŸ”„</button>
                        </div>
                    </div>
                    <div class="mb-2">
                        <input id="issues-search" type="text" placeholder="Search issues..." class="w-full bg-white border border-sky-300 rounded px-2 py-1 text-gray-800 placeholder-gray-500 text-xs focus:outline-none focus:border-sky-400">
                    </div>
                    <div id="issues-list" class="flex-1 space-y-1 overflow-y-auto">
                        <div class="text-center text-gray-600 text-xs py-4">Loading issues...</div>
                    </div>
                    <div id="prs-list" class="flex-1 space-y-1 overflow-y-auto hidden">
                        <div class="text-center text-gray-600 text-xs py-4">Loading PRs...</div>
                    </div>
                    <div id="issues-error" class="hidden mt-2 p-2 bg-red-100 border border-red-300 rounded text-red-700 text-xs"></div>
                </div>

                <!-- Push/Pull Buttons -->
                <div class="flex justify-center gap-6 mb-8">
                    <button id="push-button" class="push-button w-32 h-32 rounded-full bg-sky-500 hover:bg-sky-600 text-white font-bold text-xl shadow-lg transition-all duration-200 active:shadow-inner focus:outline-none focus:ring-4 focus:ring-sky-300 disabled:opacity-50 disabled:cursor-not-allowed flex flex-col items-center justify-center gap-2">
                        <i class="fas fa-square-caret-up text-2xl"></i>
                        <span id="button-text">PUSH</span>
                        <svg id="loading-spinner" class="loading hidden w-8 h-8" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </button>
                    <button id="pull-button" class="push-button w-32 h-32 rounded-full bg-sky-500 hover:bg-sky-600 text-white font-bold text-xl shadow-lg transition-all duration-200 active:shadow-inner focus:outline-none focus:ring-4 focus:ring-sky-300 disabled:opacity-50 disabled:cursor-not-allowed flex flex-col items-center justify-center gap-2">
                        <i class="fas fa-square-caret-down text-2xl"></i>
                        <span id="pull-button-text">PULL</span>
                        <svg id="pull-loading-spinner" class="loading hidden w-8 h-8" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </button>
                </div>

                <!-- Success Message -->
                <div id="success-message" class="hidden mt-8 text-center success-animation">
                    <div class="text-5xl mb-3">âœ“</div>
                    <div class="text-2xl font-bold text-sky-600">Success!</div>
                    <div class="text-sm text-gray-600 mt-2">Pushed to origin</div>
                    <button id="close-success-btn" class="mt-4 bg-sky-100 hover:bg-sky-200 px-4 py-2 rounded text-gray-700 text-sm">Close</button>
                </div>

                <!-- Error Message -->
                <div id="error-message" class="hidden mt-8 p-4 bg-red-100 border border-red-300 rounded-lg text-red-700 text-sm">
                </div>

                <!-- Log Output -->
                <div id="log-container" class="hidden mt-6">
                    <div class="text-xs text-gray-500 mb-2">Log Output:</div>
                    <div id="log-output" class="bg-sky-50 border border-sky-200 rounded p-3 max-h-48 overflow-y-auto font-mono text-xs text-gray-600">
                    </div>
                </div>
            </div>
        </main>

        <!-- Branch Selector Modal -->
        <div id="branch-modal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4 safe-area-inset-bottom">
            <div class="bg-sky-50 rounded-lg p-6 w-full max-w-sm max-h-96 flex flex-col border border-sky-200">
                <h2 class="text-lg font-bold text-sky-600 mb-4">Select Branch</h2>
                <div id="branches-list" class="flex-1 overflow-y-auto space-y-2 mb-4">
                    <div class="text-center text-gray-600 text-sm">Loading...</div>
                </div>
                <button id="create-branch-btn" class="w-full bg-sky-600 hover:bg-sky-500 px-4 py-2 rounded text-white text-sm font-medium mb-2 transition-colors">+ New Branch</button>
                <button id="branch-modal-close-btn" class="w-full bg-sky-100 hover:bg-sky-200 px-4 py-2 rounded text-gray-700 text-sm">Close</button>
            </div>
        </div>

        <!-- Repository Selector Modal -->
        <div id="repo-modal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4 safe-area-inset-bottom">
            <div class="bg-sky-50 rounded-lg p-6 w-full max-w-sm max-h-96 flex flex-col border border-sky-200">
                <h2 class="text-lg font-bold text-sky-600 mb-4">Select Repository</h2>
                <div id="repos-list" class="flex-1 overflow-y-auto space-y-2 mb-4">
                    <div class="text-center text-gray-600 text-sm">Loading...</div>
                </div>
                <button id="create-repo-btn" class="w-full bg-sky-600 hover:bg-sky-500 px-4 py-2 rounded text-white text-sm font-medium mb-2 transition-colors">+ New Repository</button>
                <button id="modal-close-btn" class="w-full bg-sky-100 hover:bg-sky-200 px-4 py-2 rounded text-gray-700 text-sm">Close</button>
            </div>
        </div>

        <!-- Create Repository Modal -->
        <div id="create-repo-modal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4 safe-area-inset-bottom">
            <div class="bg-sky-50 rounded-lg p-6 w-full max-w-sm border border-sky-200">
                <h2 class="text-lg font-bold text-sky-600 mb-4">Create New Repository</h2>
                <div class="space-y-4 mb-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-2">Repository Name</label>
                        <input id="create-repo-name" type="text" placeholder="my-repo" class="w-full bg-sky-100 border border-sky-200 rounded px-3 py-2 text-gray-800 placeholder-gray-500 text-sm focus:outline-none focus:border-sky-400">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-2">Subdirectories (optional)</label>
                        <input id="create-repo-subdirs" type="text" placeholder="src,tests,docs" class="w-full bg-sky-100 border border-sky-200 rounded px-3 py-2 text-gray-800 placeholder-gray-500 text-sm focus:outline-none focus:border-sky-400">
                        <div class="text-xs text-gray-500 mt-1">Comma-separated list</div>
                    </div>
                </div>
                <div id="create-repo-error" class="hidden mb-4 p-3 bg-red-100 border border-red-300 rounded text-red-700 text-sm"></div>
                <div class="flex gap-2">
                    <button id="create-repo-submit" class="flex-1 bg-sky-600 hover:bg-sky-500 px-4 py-2 rounded text-white text-sm font-medium transition-colors">Create</button>
                    <button id="create-repo-close-btn" class="flex-1 bg-sky-100 hover:bg-sky-200 px-4 py-2 rounded text-gray-700 text-sm">Cancel</button>
                </div>
            </div>
        </div>

        <!-- Remotes Management Modal -->
        <div id="remotes-modal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4 safe-area-inset-bottom">
            <div class="bg-sky-50 rounded-lg p-6 w-full max-w-sm max-h-96 flex flex-col border border-sky-200">
                <h2 class="text-lg font-bold text-sky-600 mb-4">Manage Remotes</h2>
                <div id="remotes-list" class="flex-1 overflow-y-auto space-y-2 mb-4">
                    <div class="text-center text-gray-600 text-sm">Loading...</div>
                </div>
                <button id="add-remote-btn" class="w-full bg-sky-600 hover:bg-sky-500 px-4 py-2 rounded text-white text-sm font-medium mb-2 transition-colors">+ Add Remote</button>
                <button id="remotes-modal-close-btn" class="w-full bg-sky-100 hover:bg-sky-200 px-4 py-2 rounded text-gray-700 text-sm">Close</button>
            </div>
        </div>

        <!-- Create Branch Modal -->
        <div id="create-branch-modal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4 safe-area-inset-bottom">
            <div class="bg-sky-50 rounded-lg p-6 w-full max-w-sm border border-sky-200">
                <h2 class="text-lg font-bold text-sky-600 mb-4">Create New Branch</h2>
                <div class="space-y-4 mb-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-2">Branch Name</label>
                        <input id="create-branch-name" type="text" placeholder="feature/new-feature" class="w-full bg-sky-100 border border-sky-200 rounded px-3 py-2 text-gray-800 placeholder-gray-500 text-sm focus:outline-none focus:border-sky-400">
                    </div>
                    <div class="flex items-center">
                        <input id="create-branch-checkout" type="checkbox" class="w-4 h-4 bg-sky-100 border border-sky-200 rounded">
                        <label for="create-branch-checkout" class="ml-2 text-sm text-gray-600">Switch to new branch</label>
                    </div>
                </div>
                <div id="create-branch-error" class="hidden mb-4 p-3 bg-red-100 border border-red-300 rounded text-red-700 text-sm"></div>
                <div class="flex gap-2">
                    <button id="create-branch-submit" class="flex-1 bg-sky-600 hover:bg-sky-500 px-4 py-2 rounded text-white text-sm font-medium transition-colors">Create</button>
                    <button id="create-branch-close-btn" class="flex-1 bg-sky-100 hover:bg-sky-200 px-4 py-2 rounded text-gray-700 text-sm">Cancel</button>
                </div>
            </div>
        </div>

        <!-- Add/Edit Remote Modal -->
        <div id="remote-form-modal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4 safe-area-inset-bottom">
            <div class="bg-sky-50 rounded-lg p-6 w-full max-w-sm border border-sky-200">
                <h2 id="remote-form-title" class="text-lg font-bold text-sky-600 mb-4">Add Remote</h2>
                <div class="space-y-4 mb-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-2">Remote Name</label>
                        <input id="remote-name-input" type="text" placeholder="origin" class="w-full bg-sky-100 border border-sky-200 rounded px-3 py-2 text-gray-800 placeholder-gray-500 text-sm focus:outline-none focus:border-sky-400">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-2">Repository URL</label>
                        <input id="remote-url-input" type="text" placeholder="https://github.com/user/repo.git" class="w-full bg-sky-100 border border-sky-200 rounded px-3 py-2 text-gray-800 placeholder-gray-500 text-sm focus:outline-none focus:border-sky-400">
                    </div>
                </div>
                <div id="remote-form-error" class="hidden mb-4 p-3 bg-red-100 border border-red-300 rounded text-red-700 text-sm"></div>
                <div class="flex gap-2">
                    <button id="remote-form-submit" class="flex-1 bg-sky-600 hover:bg-sky-500 px-4 py-2 rounded text-white text-sm font-medium transition-colors">Save</button>
                    <button id="remote-form-close-btn" class="flex-1 bg-sky-100 hover:bg-sky-200 px-4 py-2 rounded text-gray-700 text-sm">Cancel</button>
                </div>
            </div>
        </div>

        <!-- Settings Modal -->
        <div id="settings-modal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4 safe-area-inset-bottom">
            <div class="bg-sky-50 rounded-lg p-6 w-full max-w-sm border border-sky-200">
                <h2 class="text-lg font-bold text-sky-600 mb-4">Settings</h2>
                
                <!-- Systemd Registration Section -->
                <div class="space-y-4 mb-6">
                    <div class="border border-sky-200 rounded p-4 bg-white/50">
                        <div class="flex items-center justify-between mb-3">
                            <div>
                                <h3 class="text-sm font-semibold text-gray-700">Auto-Start with Systemd</h3>
                                <p class="text-xs text-gray-600 mt-1">Register AirGit to auto-start on login</p>
                            </div>
                            <div id="systemd-status-badge" class="px-2 py-1 rounded text-xs font-medium bg-sky-100 text-gray-600">
                                Checking...
                            </div>
                        </div>
                        <div id="systemd-status-message" class="text-xs text-gray-600 mb-3"></div>
                        <button id="systemd-register-btn" class="w-full bg-sky-600 hover:bg-sky-500 px-4 py-2 rounded text-white text-sm font-medium transition-colors">
                            <span id="systemd-btn-text">Register with Systemd</span>
                            <svg id="systemd-spinner" class="loading hidden inline-block w-4 h-4 ml-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                        </button>
                    </div>

                    <!-- Service Status Section -->
                    <div class="border border-sky-200 rounded p-4 bg-white/50">
                        <div class="flex items-center justify-between mb-3">
                            <div>
                                <h3 class="text-sm font-semibold text-gray-700">Service Status</h3>
                                <p class="text-xs text-gray-600 mt-1">Start AirGit via systemd</p>
                            </div>
                            <div id="service-status-badge" class="px-2 py-1 rounded text-xs font-medium bg-sky-100 text-gray-600">
                                Checking...
                            </div>
                        </div>
                        <div id="service-status-message" class="text-xs text-gray-600 mb-3"></div>
                        <button id="service-start-btn" class="w-full bg-sky-600 hover:bg-sky-500 px-4 py-2 rounded text-white text-sm font-medium transition-colors">
                            <span id="service-btn-text">Start Service</span>
                            <svg id="service-spinner" class="loading hidden inline-block w-4 h-4 ml-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                        </button>
                    </div>

                    <!-- Rebuild & Restart Section -->
                    <div class="border border-sky-200 rounded p-4 bg-white/50">
                        <div class="flex items-center justify-between mb-3">
                            <div>
                                <h3 class="text-sm font-semibold text-gray-700">Rebuild & Restart</h3>
                                <p class="text-xs text-gray-600 mt-1">Build and restart the service</p>
                            </div>
                            <div id="rebuild-status-badge" class="px-2 py-1 rounded text-xs font-medium bg-sky-100 text-gray-600">
                                Ready
                            </div>
                        </div>
                        <div id="rebuild-status-message" class="text-xs text-gray-600 mb-3"></div>
                        <button id="rebuild-restart-btn" class="w-full bg-sky-600 hover:bg-sky-500 px-4 py-2 rounded text-white text-sm font-medium transition-colors">
                            <span id="rebuild-btn-text">ðŸ”¨ Build & Restart</span>
                            <svg id="rebuild-spinner" class="loading hidden inline-block w-4 h-4 ml-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                        </button>
                    </div>

                    <!-- GitHub OAuth Section -->
                    <div class="border border-sky-200 rounded p-4 bg-white/50">
                        <div class="flex items-center justify-between mb-3">
                            <div>
                                <h3 class="text-sm font-semibold text-gray-700">GitHub Authentication</h3>
                                <p class="text-xs text-gray-600 mt-1">Required for Agent features</p>
                            </div>
                            <div id="github-auth-badge" class="px-2 py-1 rounded text-xs font-medium bg-sky-100 text-gray-600">
                                Checking...
                            </div>
                        </div>
                        <div id="github-auth-message" class="text-xs text-gray-600 mb-3"></div>
                        <button id="github-auth-btn" class="w-full bg-sky-600 hover:bg-sky-500 px-4 py-2 rounded text-white text-sm font-medium transition-colors">
                            <span id="github-auth-btn-text">Authenticate with GitHub</span>
                            <svg id="github-auth-spinner" class="loading hidden inline-block w-4 h-4 ml-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                        </button>
                    </div>

                    <!-- PWA Install Section -->
                    <div id="pwa-section" class="border border-sky-200 rounded p-4 bg-white/50">
                        <div class="flex items-center justify-between mb-3">
                            <div>
                                <h3 class="text-sm font-semibold text-gray-700">Install App</h3>
                                <p class="text-xs text-gray-600 mt-1">Add AirGit to your home screen</p>
                            </div>
                            <div id="pwa-status-badge" class="px-2 py-1 rounded text-xs font-medium bg-sky-100 text-sky-600">
                                Ready
                            </div>
                        </div>
                        <div id="pwa-status-message" class="text-xs text-gray-600 mb-3"></div>
                        <button id="pwa-install-btn" class="w-full bg-sky-600 hover:bg-sky-500 px-4 py-2 rounded text-white text-sm font-medium transition-colors">
                            <span id="pwa-btn-text">Install App</span>
                            <svg id="pwa-spinner" class="loading hidden inline-block w-4 h-4 ml-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                        </button>
                    </div>
                </div>

                <button id="settings-modal-close-btn" class="w-full bg-sky-100 hover:bg-sky-200 px-4 py-2 rounded text-gray-700 text-sm">Close</button>
            </div>
        </div>

        <!-- Tags Management Modal -->
        <div id="tags-modal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4 safe-area-inset-bottom">
            <div class="bg-sky-50 rounded-lg p-6 w-full max-w-sm max-h-96 flex flex-col border border-sky-200">
                <h2 class="text-lg font-bold text-sky-600 mb-4">Tags</h2>
                <div id="tags-list" class="flex-1 overflow-y-auto space-y-2 mb-4">
                    <div class="text-center text-gray-600 text-sm">Loading...</div>
                </div>
                <button id="create-tag-btn" class="w-full bg-sky-600 hover:bg-sky-500 px-4 py-2 rounded text-white text-sm font-medium mb-2 transition-colors">+ Create Tag</button>
                <button id="tags-modal-close-btn" class="w-full bg-sky-100 hover:bg-sky-200 px-4 py-2 rounded text-gray-700 text-sm">Close</button>
            </div>
        </div>

        <!-- Create Issue Modal -->
        <div id="create-issue-modal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4 safe-area-inset-bottom">
            <div class="bg-sky-50 rounded-lg p-6 w-full max-w-sm border border-sky-200">
                <h2 class="text-lg font-bold text-sky-600 mb-4">Create New Issue</h2>
                <div class="space-y-4 mb-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-2">Title</label>
                        <input id="create-issue-title" type="text" placeholder="Issue title" class="w-full bg-sky-100 border border-sky-200 rounded px-3 py-2 text-gray-800 placeholder-gray-500 text-sm focus:outline-none focus:border-sky-400">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-2">Description</label>
                        <textarea id="create-issue-body" placeholder="Issue description" rows="6" class="w-full bg-sky-100 border border-sky-200 rounded px-3 py-2 text-gray-800 placeholder-gray-500 text-sm focus:outline-none focus:border-sky-400"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-2">Labels (optional)</label>
                        <input id="create-issue-labels" type="text" placeholder="bug, enhancement, help wanted" class="w-full bg-sky-100 border border-sky-200 rounded px-3 py-2 text-gray-800 placeholder-gray-500 text-sm focus:outline-none focus:border-sky-400">
                        <div class="text-xs text-gray-500 mt-1">Comma-separated list</div>
                    </div>
                </div>
                <div id="create-issue-error" class="hidden mb-4 p-3 bg-red-100 border border-red-300 rounded text-red-700 text-sm"></div>
                <div class="flex gap-2">
                    <button id="create-issue-submit" class="flex-1 bg-sky-600 hover:bg-sky-500 px-4 py-2 rounded text-white text-sm font-medium transition-colors">Create</button>
                    <button id="create-issue-close-btn" class="flex-1 bg-sky-100 hover:bg-sky-200 px-4 py-2 rounded text-gray-700 text-sm">Cancel</button>
                </div>
            </div>
        </div>

        <!-- Create Tag Modal -->
        <div id="create-tag-modal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4 safe-area-inset-bottom">
            <div class="bg-sky-50 rounded-lg p-6 w-full max-w-sm border border-sky-200">
                <h2 class="text-lg font-bold text-sky-600 mb-4">Create New Tag</h2>
                <div class="space-y-4 mb-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-2">Tag Name</label>
                        <input id="create-tag-name" type="text" placeholder="v1.0.0" class="w-full bg-sky-100 border border-sky-200 rounded px-3 py-2 text-gray-800 placeholder-gray-500 text-sm focus:outline-none focus:border-sky-400">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-2">Message (Optional)</label>
                        <input id="create-tag-message" type="text" placeholder="Release version 1.0.0" class="w-full bg-sky-100 border border-sky-200 rounded px-3 py-2 text-gray-800 placeholder-gray-500 text-sm focus:outline-none focus:border-sky-400">
                        <div class="text-xs text-gray-500 mt-1">Creates annotated tag if provided</div>
                    </div>
                </div>
                <div id="create-tag-error" class="hidden mb-4 p-3 bg-red-100 border border-red-300 rounded text-red-700 text-sm"></div>
                <div class="flex gap-2">
                    <button id="create-tag-submit" class="flex-1 bg-sky-600 hover:bg-sky-500 px-4 py-2 rounded text-white text-sm font-medium transition-colors">Create</button>
                    <button id="create-tag-close-btn" class="flex-1 bg-sky-100 hover:bg-sky-200 px-4 py-2 rounded text-gray-700 text-sm">Cancel</button>
                </div>
            </div>
        </div>

        <!-- Push Tag Modal -->
        <div id="push-tag-modal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4 safe-area-inset-bottom">
            <div class="bg-sky-50 rounded-lg p-6 w-full max-w-sm border border-sky-200">
                <h2 class="text-lg font-bold text-sky-600 mb-4">Push Tag</h2>
                <div class="space-y-4 mb-6">
                    <div id="push-tag-info" class="text-sm text-gray-600">
                        <!-- Will be filled by JavaScript -->
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-2">Remote</label>
                        <select id="push-tag-remote" class="w-full bg-sky-100 border border-sky-200 rounded px-3 py-2 text-gray-800 text-sm focus:outline-none focus:border-sky-400">
                            <option value="origin">origin</option>
                        </select>
                    </div>
                </div>
                <div id="push-tag-error" class="hidden mb-4 p-3 bg-red-100 border border-red-300 rounded text-red-700 text-sm"></div>
                <div class="flex gap-2">
                    <button id="push-tag-submit" class="flex-1 bg-sky-600 hover:bg-sky-500 px-4 py-2 rounded text-white text-sm font-medium transition-colors">Push</button>
                    <button id="push-tag-close-btn" class="flex-1 bg-sky-100 hover:bg-sky-200 px-4 py-2 rounded text-gray-700 text-sm">Cancel</button>
                </div>
            </div>
        </div>

        <!-- PR Reviews Modal -->
        <div id="pr-reviews-modal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4 safe-area-inset-bottom">
            <div class="bg-sky-50 rounded-lg p-6 w-full max-w-sm max-h-[80vh] flex flex-col border border-sky-200">
                <h2 class="text-lg font-bold text-sky-600 mb-2">PR Reviews</h2>
                <div id="pr-reviews-info" class="text-sm text-gray-600 mb-4"></div>
                <div id="pr-reviews-content" class="flex-1 overflow-y-auto space-y-3 mb-4">
                    <div class="text-center text-gray-600 text-sm">Loading reviews...</div>
                </div>
                <div id="pr-review-progress" class="text-xs text-sky-600 mb-2 hidden italic animate-pulse"></div>
                <div class="space-y-2">
                    <button id="pr-apply-review-btn" class="w-full bg-sky-600 hover:bg-sky-500 px-4 py-2 rounded text-white text-sm font-medium transition-colors">ðŸ¤– Apply Review Comments with Agent</button>
                    <button id="pr-reviews-modal-close-btn" class="w-full bg-sky-100 hover:bg-sky-200 px-4 py-2 rounded text-gray-700 text-sm">Close</button>
                </div>
            </div>
        </div>

        <!-- Commits Modal -->
        <div id="commits-modal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4 safe-area-inset-bottom">
            <div class="bg-sky-50 rounded-lg p-6 w-full max-w-sm max-h-96 flex flex-col border border-sky-200">
                <h2 class="text-lg font-bold text-sky-600 mb-4">Recent Commits (Last 20)</h2>
                <div id="commits-list" class="flex-1 overflow-y-auto space-y-2 mb-4">
                    <div class="text-center text-gray-600 text-sm">Loading...</div>
                </div>
                <button id="commits-modal-close-btn" class="w-full bg-sky-100 hover:bg-sky-200 px-4 py-2 rounded text-gray-700 text-sm">Close</button>
            </div>
        </div>
    </div>

    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/service-worker.js', { 
                scope: '/',
                updateViaCache: 'none'
            })
                .then((registration) => {
                    console.log('âœ“ Service Worker registered successfully:', registration);
                })
                .catch((error) => {
                    console.error('âœ— Service Worker registration failed:', error);
                });
        }

        const pushButton = document.getElementById('push-button');
        const pullButton = document.getElementById('pull-button');
        const buttonText = document.getElementById('button-text');
        const pullButtonText = document.getElementById('pull-button-text');
        const loadingSpinner = document.getElementById('loading-spinner');
        const pullLoadingSpinner = document.getElementById('pull-loading-spinner');
        const statusContainer = document.getElementById('status-container');
        const successMessage = document.getElementById('success-message');
        const closeSuccessBtn = document.getElementById('close-success-btn');
        const errorMessage = document.getElementById('error-message');
        const logContainer = document.getElementById('log-container');
        const logOutput = document.getElementById('log-output');
        console.log('Elements loaded:', { pushButton, pullButton, logContainer, logOutput });
        const branchName = document.getElementById('branch-name');
        const repoName = document.getElementById('repo-name');
        const trackingInfo = document.getElementById('tracking-info');
        const aheadBehindStatus = document.getElementById('ahead-behind-status');
        const branchSelectorBtn = document.getElementById('branch-selector-btn');
        const branchModal = document.getElementById('branch-modal');
        const branchesList = document.getElementById('branches-list');
        const branchModalCloseBtn = document.getElementById('branch-modal-close-btn');
        const repoSelectorBtn = document.getElementById('repo-selector-btn');
        const repoModal = document.getElementById('repo-modal');
        const reposList = document.getElementById('repos-list');
        const modalCloseBtn = document.getElementById('modal-close-btn');
        const createRepoBtn = document.getElementById('create-repo-btn');
        const createRepoModal = document.getElementById('create-repo-modal');
        const createRepoNameInput = document.getElementById('create-repo-name');
        const createRepoSubdirsInput = document.getElementById('create-repo-subdirs');
        const createRepoSubmitBtn = document.getElementById('create-repo-submit');
        const createRepoCloseBtn = document.getElementById('create-repo-close-btn');
        const createRepoError = document.getElementById('create-repo-error');
        const remotesSelectorBtn = document.getElementById('remotes-selector-btn');
        const remotesModal = document.getElementById('remotes-modal');
        const remotesList = document.getElementById('remotes-list');
        const remotesModalCloseBtn = document.getElementById('remotes-modal-close-btn');
        const addRemoteBtn = document.getElementById('add-remote-btn');
        const remoteFormModal = document.getElementById('remote-form-modal');
        const remoteFormTitle = document.getElementById('remote-form-title');
        const remoteNameInput = document.getElementById('remote-name-input');
        const remoteUrlInput = document.getElementById('remote-url-input');
        const remoteFormSubmitBtn = document.getElementById('remote-form-submit');
        const remoteFormCloseBtn = document.getElementById('remote-form-close-btn');
        const remoteFormError = document.getElementById('remote-form-error');
        const createBranchBtn = document.getElementById('create-branch-btn');
        const createBranchModal = document.getElementById('create-branch-modal');
        const createBranchNameInput = document.getElementById('create-branch-name');
        const createBranchCheckout = document.getElementById('create-branch-checkout');
        const createBranchSubmitBtn = document.getElementById('create-branch-submit');
        const createBranchCloseBtn = document.getElementById('create-branch-close-btn');
        const createBranchError = document.getElementById('create-branch-error');
        const commitsBtn = document.getElementById('commits-btn');
        const commitsModal = document.getElementById('commits-modal');
        const commitsList = document.getElementById('commits-list');
        const commitsModalCloseBtn = document.getElementById('commits-modal-close-btn');
        const tagsBtn = document.getElementById('tags-btn');
        const tagsModal = document.getElementById('tags-modal');
        const tagsList = document.getElementById('tags-list');
        const tagsModalCloseBtn = document.getElementById('tags-modal-close-btn');
        const createTagBtn = document.getElementById('create-tag-btn');
        const createTagModal = document.getElementById('create-tag-modal');
        const createTagNameInput = document.getElementById('create-tag-name');
        const createTagMessageInput = document.getElementById('create-tag-message');
        const createTagSubmitBtn = document.getElementById('create-tag-submit');
        const createTagCloseBtn = document.getElementById('create-tag-close-btn');
        const createTagError = document.getElementById('create-tag-error');
        const createIssueBtn = document.getElementById('create-issue-btn');
        const createIssueModal = document.getElementById('create-issue-modal');
        const createIssueTitleInput = document.getElementById('create-issue-title');
        const createIssueBodyInput = document.getElementById('create-issue-body');
        const createIssueLabelsInput = document.getElementById('create-issue-labels');
        const createIssueSubmitBtn = document.getElementById('create-issue-submit');
        const createIssueCloseBtn = document.getElementById('create-issue-close-btn');
        const createIssueError = document.getElementById('create-issue-error');
        const pushTagModal = document.getElementById('push-tag-modal');
        const pushTagInfo = document.getElementById('push-tag-info');
        const pushTagRemote = document.getElementById('push-tag-remote');
        const pushTagSubmitBtn = document.getElementById('push-tag-submit');
        const pushTagCloseBtn = document.getElementById('push-tag-close-btn');
        const pushTagError = document.getElementById('push-tag-error');
        const issuesPanel = document.getElementById('issues-panel');
        const issuesError = document.getElementById('issues-error');
        const prsList = document.getElementById('prs-list');
        const viewToggleBtn = document.getElementById('view-toggle-btn');
        const prReviewsModal = document.getElementById('pr-reviews-modal');
        const prReviewsInfo = document.getElementById('pr-reviews-info');
        const prReviewsContent = document.getElementById('pr-reviews-content');
        const prApplyReviewBtn = document.getElementById('pr-apply-review-btn');
        const prReviewsModalCloseBtn = document.getElementById('pr-reviews-modal-close-btn');
        let currentIssuesUrl = null;
        let currentEditingRemote = null;
        let selectedTagForPush = null;
        let allIssues = [];  // Store all issues for filtering
        let issuesOwner = null;  // GitHub repo owner
        let issuesRepo = null;   // GitHub repo name
        let currentView = 'issues'; // 'issues' or 'prs'
        let allPRs = [];
        let currentPRNumber = null;
        let currentIssueForReview = null;

        function getCurrentRepositoryPath() {
            const pathname = window.location.pathname;
            if (pathname && pathname !== '/') {
                return pathname;
            }
            return null;
        }

        function getCurrentBranch() {
            const params = new URLSearchParams(window.location.search);
            return params.get('b');
        }

        async function loadStatus() {
            try {
                const url = new URL('/api/status', window.location.origin);
                // Don't send repoPath parameter - use server's default config.RepoPath
                const response = await fetch(url.toString());
                const data = await response.json();
                if (response.ok) {
                    branchName.textContent = data.branch || 'unknown';
                    if (data.repoName) {
                        repoName.textContent = data.repoName;
                    }
                    displayAheadBehind(data.ahead || 0, data.behind || 0);
                } else {
                    branchName.textContent = 'Error';
                }
            } catch (error) {
                branchName.textContent = 'Error';
            }
        }

        async function initializeFromUrl() {
            const repoPath = getCurrentRepositoryPath();
            const branch = getCurrentBranch();

            // If no path and no branch parameter, just load status
            if (!repoPath && !branch) {
                loadStatus();
                return;
            }

            try {
                const url = new URL('/api/load-repo', window.location.origin);
                if (repoPath) url.searchParams.append('p', repoPath);
                if (branch) url.searchParams.append('b', branch);

                const response = await fetch(url.toString());
                const data = await response.json();

                if (response.ok) {
                    branchName.textContent = data.branch || 'unknown';
                    if (data.repoName) {
                        repoName.textContent = data.repoName;
                    }
                    displayAheadBehind(data.ahead || 0, data.behind || 0);
                } else {
                    branchName.textContent = 'Error';
                    console.error('Load repo error:', data);
                }
            } catch (error) {
                console.error('Load repo failed:', error);
                loadStatus();
            }
        }

        async function loadBranches() {
            try {
                const repoPath = getCurrentRepositoryPath();
                const url = new URL('/api/branches', window.location.origin);
                if (repoPath) {
                    url.searchParams.append('repoPath', repoPath);
                }
                const response = await fetch(url.toString());
                const data = await response.json();
                if (response.ok && data.branches) {
                    displayBranches(data.branches);
                } else if (data.error) {
                    branchesList.innerHTML = `<div class="text-center text-red-400 text-sm">${escapeHtml(data.error)}</div>`;
                } else {
                    branchesList.innerHTML = `<div class="text-center text-red-400 text-sm">Failed to load branches</div>`;
                }
            } catch (error) {
                console.error('Branch load error:', error);
                branchesList.innerHTML = `<div class="text-center text-red-400 text-sm">Connection failed: ${escapeHtml(error.message)}</div>`;
            }
        }

        function displayBranches(branches) {
            if (branches.length === 0) {
                branchesList.innerHTML = '<div class="text-center text-gray-600 text-sm">No branches found</div>';
                return;
            }

            branchesList.innerHTML = branches.map(branch => `
                <button class="w-full text-left bg-sky-100 hover:bg-sky-200 px-4 py-3 rounded text-gray-700 text-sm transition-colors"
                        onclick="checkoutBranch('${escapeHtml(branch)}')">
                    <div class="font-semibold text-sky-600">${escapeHtml(branch)}</div>
                    <div id="branch-status-${escapeHtml(branch)}" class="text-xs text-gray-600 mt-1"></div>
                </button>
            `).join('');

            // Load ahead/behind info for each branch
            branches.forEach(async (branch) => {
                try {
                    // Get the ahead/behind info by temporarily checking out the branch
                    // Actually, we can fetch this without checkout by using git rev-list
                    // For now, we'll display the info after checkout
                } catch (error) {
                    console.error(`Failed to get info for ${branch}:`, error);
                }
            });
        }

        async function checkoutBranch(branch) {
            try {
                const response = await fetch('/api/checkout', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        branch: branch
                    })
                });
                const data = await response.json();

                if (response.ok) {
                    branchName.textContent = data.branch || 'unknown';
                    displayAheadBehind(data.ahead || 0, data.behind || 0);
                    branchModal.classList.add('hidden');
                    
                    // Update URL to reflect the new branch
                    const url = new URL(window.location);
                    url.searchParams.set('b', data.branch);
                    window.history.pushState({}, '', url.toString());
                } else {
                    alert(`Error checking out branch: ${data.error || 'Unknown error'}`);
                }
            } catch (error) {
                alert(`Connection error: ${error.message}`);
            }
        }

        async function loadRepositories() {
             try {
                 const response = await fetch('/api/repos');
                 const data = await response.json();
                 if (response.ok && data.repositories) {
                     displayRepositories(data.repositories);
                 } else if (data.error) {
                     reposList.innerHTML = `<div class="text-center text-red-400 text-sm">${escapeHtml(data.error)}</div>`;
                 } else {
                     reposList.innerHTML = `<div class="text-center text-red-400 text-sm">Failed to load repositories</div>`;
                 }
             } catch (error) {
                 console.error('Repository load error:', error);
                 reposList.innerHTML = `<div class="text-center text-red-400 text-sm">Connection failed: ${escapeHtml(error.message)}</div>`;
             }
         }

        function displayRepositories(repos) {
            if (repos.length === 0) {
                reposList.innerHTML = '<div class="text-center text-gray-600 text-sm">No repositories found</div>';
                return;
            }

            reposList.innerHTML = repos.map(repo => `
                <button class="w-full text-left bg-sky-100 hover:bg-sky-200 px-4 py-3 rounded text-gray-700 text-sm transition-colors"
                        onclick="selectRepository('${escapeHtml(repo.name)}', '${escapeHtml(repo.path)}')">
                    <div class="font-semibold text-sky-600">${escapeHtml(repo.name)}</div>
                    <div class="text-xs text-gray-600 truncate">${escapeHtml(repo.path)}</div>
                </button>
            `).join('');
        }

        async function selectRepository(name, relativePath) {
            try {
                repoModal.classList.add('hidden');
                
                // Navigate to the repository URL with the branch parameter
                const url = new URL(window.location.origin);
                url.pathname = '/' + relativePath;
                window.location.href = url.toString();
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }

        function resetUI() {
            pushButton.disabled = false;
            pullButton.disabled = false;
            buttonText.textContent = 'PUSH';
            pullButtonText.textContent = 'PULL';
            loadingSpinner.classList.add('hidden');
            pullLoadingSpinner.classList.add('hidden');
            buttonText.classList.remove('hidden');
            pullButtonText.classList.remove('hidden');
            successMessage.classList.add('hidden');
            errorMessage.classList.add('hidden');
            logContainer.classList.add('hidden');
            statusContainer.classList.add('hidden');
        }

        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.classList.remove('hidden');
        }

        function showLog(lines) {
            try {
                console.log('showLog called with lines:', lines);
                logContainer.style.display = 'block';  // Force display
                logContainer.classList.remove('hidden');
                logOutput.innerHTML = '';
                if (Array.isArray(lines)) {
                    lines.forEach(line => {
                        const div = document.createElement('div');
                        div.textContent = line;
                        logOutput.appendChild(div);
                    });
                }
                logOutput.scrollTop = logOutput.scrollHeight;
                console.log('showLog completed');
            } catch (error) {
                console.error('showLog error:', error);
                logContainer.classList.remove('hidden');
                logOutput.textContent = 'Error displaying log';
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-sky-600 text-white px-4 py-3 rounded-lg shadow-lg max-w-xs z-50';
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        function showErrorNotification(message, duration = 5000) {
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-red-600 text-white px-4 py-3 rounded-lg shadow-lg max-w-xs z-50';
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => {
                notification.remove();
            }, duration);
        }

        function displayAheadBehind(ahead, behind) {
            if (ahead === 0 && behind === 0) {
                trackingInfo.classList.add('hidden');
                return;
            }

            let status = '';
            if (ahead > 0 && behind === 0) {
                status = `ðŸ“¤ ${ahead} commit${ahead > 1 ? 's' : ''} ahead`;
            } else if (behind > 0 && ahead === 0) {
                status = `ðŸ“¥ ${behind} commit${behind > 1 ? 's' : ''} behind`;
            } else if (ahead > 0 && behind > 0) {
                status = `ðŸ“¤ ${ahead} ahead / ðŸ“¥ ${behind} behind`;
            }

            if (status) {
                aheadBehindStatus.textContent = status;
                trackingInfo.classList.remove('hidden');
            } else {
                trackingInfo.classList.add('hidden');
            }
        }

        branchSelectorBtn.addEventListener('click', async () => {
            branchModal.classList.remove('hidden');
            loadBranches();
        });

        branchModalCloseBtn.addEventListener('click', () => {
            branchModal.classList.add('hidden');
        });

        branchModal.addEventListener('click', (e) => {
            if (e.target === branchModal) {
                branchModal.classList.add('hidden');
            }
        });

        repoSelectorBtn.addEventListener('click', () => {
            repoModal.classList.remove('hidden');
            loadRepositories();
        });

        modalCloseBtn.addEventListener('click', () => {
            repoModal.classList.add('hidden');
        });

        repoModal.addEventListener('click', (e) => {
            if (e.target === repoModal) {
                repoModal.classList.add('hidden');
            }
        });

        createRepoBtn.addEventListener('click', () => {
            repoModal.classList.add('hidden');
            createRepoModal.classList.remove('hidden');
            createRepoNameInput.value = '';
            createRepoSubdirsInput.value = '';
            createRepoError.classList.add('hidden');
            createRepoNameInput.focus();
        });

        createRepoCloseBtn.addEventListener('click', () => {
            createRepoModal.classList.add('hidden');
        });

        remotesSelectorBtn.addEventListener('click', async () => {
            remotesModal.classList.remove('hidden');
            loadRemotes();
        });

        remotesModalCloseBtn.addEventListener('click', () => {
            remotesModal.classList.add('hidden');
        });

        remotesModal.addEventListener('click', (e) => {
            if (e.target === remotesModal) {
                remotesModal.classList.add('hidden');
            }
        });

        addRemoteBtn.addEventListener('click', () => {
            remotesModal.classList.add('hidden');
            openAddRemoteForm();
        });

        createBranchBtn.addEventListener('click', () => {
            branchModal.classList.add('hidden');
            openCreateBranchForm();
        });

        createBranchCloseBtn.addEventListener('click', () => {
            createBranchModal.classList.add('hidden');
        });

        createBranchModal.addEventListener('click', (e) => {
            if (e.target === createBranchModal) {
                createBranchModal.classList.add('hidden');
            }
        });

        commitsBtn.addEventListener('click', async () => {
            commitsModal.classList.remove('hidden');
            loadCommits();
        });

        commitsModalCloseBtn.addEventListener('click', () => {
            commitsModal.classList.add('hidden');
        });

        commitsModal.addEventListener('click', (e) => {
            if (e.target === commitsModal) {
                commitsModal.classList.add('hidden');
            }
        });

        // Tags event listeners
        tagsBtn.addEventListener('click', async () => {
            tagsModal.classList.remove('hidden');
            loadTags();
        });

        tagsModalCloseBtn.addEventListener('click', () => {
            tagsModal.classList.add('hidden');
        });

        tagsModal.addEventListener('click', (e) => {
            if (e.target === tagsModal) {
                tagsModal.classList.add('hidden');
            }
        });

        createTagBtn.addEventListener('click', () => {
            createTagModal.classList.remove('hidden');
            createTagError.classList.add('hidden');
            createTagNameInput.value = '';
            createTagMessageInput.value = '';
        });

        createTagCloseBtn.addEventListener('click', () => {
            createTagModal.classList.add('hidden');
        });

        createTagModal.addEventListener('click', (e) => {
            if (e.target === createTagModal) {
                createTagModal.classList.add('hidden');
            }
        });

        createTagSubmitBtn.addEventListener('click', createTag);

        // Create Issue event listeners
        createIssueBtn.addEventListener('click', () => {
            createIssueModal.classList.remove('hidden');
            createIssueError.classList.add('hidden');
            createIssueTitleInput.value = '';
            createIssueBodyInput.value = '';
            createIssueLabelsInput.value = '';
            createIssueTitleInput.focus();
        });

        createIssueCloseBtn.addEventListener('click', () => {
            createIssueModal.classList.add('hidden');
        });

        createIssueModal.addEventListener('click', (e) => {
            if (e.target === createIssueModal) {
                createIssueModal.classList.add('hidden');
            }
        });

        createIssueSubmitBtn.addEventListener('click', createIssue);

        pushTagCloseBtn.addEventListener('click', () => {
            pushTagModal.classList.add('hidden');
        });

        pushTagModal.addEventListener('click', (e) => {
            if (e.target === pushTagModal) {
                pushTagModal.classList.add('hidden');
            }
        });

        pushTagSubmitBtn.addEventListener('click', pushTag);

        // GitHub Issues - Auto-load on page load
        async function loadGitHubIssues() {
            issuesError.classList.add('hidden');
            document.getElementById('issues-list').innerHTML = '<div class="text-center text-gray-600 text-xs py-2">Loading issues...</div>';
            
            // Fetch current repository's GitHub issues
            try {
                const repoPath = getCurrentRepositoryPath();
                const url = new URL('/api/github/issues', window.location.origin);
                
                // Use provided repoPath if available
                if (repoPath && repoPath !== '/') {
                    url.searchParams.append('repoPath', repoPath);
                }
                
                console.log('Fetching issues from:', url.toString());
                const response = await fetch(url.toString());
                const data = await response.json();
                
                console.log('Issues response:', data);
                
                if (response.ok && data.owner) {
                    issuesOwner = data.owner;
                    issuesRepo = data.repo;
                    if (data.error) {
                        showIssuesError(`Error fetching issues: ${data.error}`);
                    } else if (data.issues && data.issues.length > 0) {
                        allIssues = data.issues;
                        displayFilteredIssues(allIssues);
                    } else {
                        document.getElementById('issues-list').innerHTML = '<div class="text-center text-gray-600 text-xs py-2">No open issues found</div>';
                    }
                } else {
                    showIssuesError(data.error || 'Could not detect GitHub repository');
                }
            } catch (error) {
                console.error('Issues load error:', error);
                showIssuesError('Connection error: ' + error.message);
            }
        }
        
        // Load issues on page load
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', loadGitHubIssues);
        } else {
            loadGitHubIssues();
        }
        
        function displayFilteredIssues(issuesToDisplay) {
            const issuesList = document.getElementById('issues-list');
            if (issuesToDisplay.length === 0) {
                issuesList.innerHTML = '<div class="text-center text-gray-600 text-sm py-4">No issues match your search</div>';
                return;
            }
            
            // Limit to 10 issues
            const limitedIssues = issuesToDisplay.slice(0, 10);
            issuesList.innerHTML = limitedIssues.map(issue => {
                const assigneeNames = (issue.assignees && Array.isArray(issue.assignees)) 
                    ? issue.assignees.map(a => a.login || a).join(', ')
                    : '';
                const issueUrl = issuesOwner && issuesRepo 
                    ? `https://github.com/${issuesOwner}/${issuesRepo}/issues/${issue.number}`
                    : '#';
                return `
                <div class="bg-white border border-sky-200 rounded p-3 hover:bg-sky-50 transition-colors">
                    <div class="flex justify-between items-start gap-2">
                        <div class="flex-1">
                            <div class="font-semibold text-sky-700"><a href="${issueUrl}" target="_blank" rel="noopener noreferrer" class="hover:underline">#${issue.number} ${issue.title}</a></div>
                            <div class="text-xs text-gray-500 mt-1">Author: ${(issue.author && issue.author.login) ? issue.author.login : (typeof issue.author === 'string' ? issue.author : 'unknown')}</div>
                            ${assigneeNames ? `<div class="text-xs text-gray-500">Assignee: ${assigneeNames}</div>` : ''}
                            <div class="text-xs text-gray-600 mt-1">${(issue.body || '').substring(0, 80)}${(issue.body || '').length > 80 ? '...' : ''}</div>
                            <div class="agent-progress-${issue.number} text-xs text-sky-600 mt-1 hidden italic"></div>
                        </div>
                        <button class="agent-run-btn bg-sky-600 hover:bg-sky-500 text-white text-xs px-3 py-1 rounded transition-colors whitespace-nowrap" data-issue-number="${issue.number}" data-issue-title="${issue.title.replace(/"/g, '&quot;')}" data-issue-body="${(issue.body || '').replace(/"/g, '&quot;')}">
                            ðŸ¤– Agent
                        </button>
                    </div>
                </div>
            `}).join('');
            
            
            if (issuesToDisplay.length > 10) {
                issuesList.innerHTML += `<div class="text-center text-gray-500 text-xs py-2">Showing 10 of ${issuesToDisplay.length} issues</div>`;
            }
            
            // Attach event listeners to agent buttons
            document.querySelectorAll('.agent-run-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    const issueNumber = btn.dataset.issueNumber;
                    const issueTitle = btn.dataset.issueTitle;
                    const issueBody = btn.dataset.issueBody;
                    
                    btn.disabled = true;
                    btn.textContent = 'â³ Running...';
                    
                    // Get progress element and show initial message immediately
                    const progressEl = document.querySelector(`.agent-progress-${issueNumber}`);
                    if (progressEl) {
                        progressEl.textContent = 'âš™ï¸ Starting agent process...';
                        progressEl.classList.remove('hidden', 'text-red-600');
                        progressEl.classList.add('text-sky-600');
                    }
                    
                    try {
                        const response = await fetch('/api/agent/process', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                issue_number: parseInt(issueNumber),
                                issue_title: issueTitle,
                                issue_body: issueBody
                            })
                        });
                        
                        if (response.ok) {
                            // Poll for status
                            let maxAttempts = 5400; // 180 minutes / 3 hours (5400 * 2 seconds)
                            const pollInterval = setInterval(async () => {
                                maxAttempts--;
                                if (maxAttempts <= 0) {
                                    clearInterval(pollInterval);
                                    btn.textContent = 'â±ï¸ Timeout';
                                    btn.classList.add('bg-yellow-600', 'hover:bg-yellow-500');
                                    btn.classList.remove('bg-sky-600', 'hover:bg-sky-500');
                                    btn.disabled = false;
                                    if (progressEl) {
                                        progressEl.classList.add('hidden');
                                    }
                                    return;
                                }
                                
                                try {
                                    const statusResponse = await fetch(`/api/agent/status?issue_number=${issueNumber}`);
                                    if (statusResponse.ok) {
                                        const status = await statusResponse.json();
                                        
                                        // Update progress message
                                        if (progressEl && status.message) {
                                            progressEl.textContent = 'âš™ï¸ ' + status.message;
                                            progressEl.classList.remove('hidden');
                                        }
                                        
                                        if (status.status === 'completed') {
                                            clearInterval(pollInterval);
                                            btn.textContent = 'âœ… Done';
                                            btn.classList.add('bg-green-600', 'hover:bg-green-500');
                                            btn.classList.remove('bg-sky-600', 'hover:bg-sky-500');
                                            btn.disabled = false;
                                            if (progressEl) {
                                                progressEl.textContent = 'âœ“ ' + status.message;
                                            }
                                        } else if (status.status === 'failed') {
                                            clearInterval(pollInterval);
                                            btn.textContent = 'âŒ Error';
                                            btn.classList.add('bg-red-600', 'hover:bg-red-500');
                                            btn.classList.remove('bg-sky-600', 'hover:bg-sky-500');
                                            btn.disabled = false;
                                            if (progressEl) {
                                                // Show full error message in progress element
                                                const errorText = status.message || 'Unknown error';
                                                progressEl.innerHTML = `<span class="font-semibold">âœ— Error:</span><br><span class="whitespace-pre-wrap">${errorText}</span>`;
                                                progressEl.classList.remove('text-sky-600', 'hidden');
                                                progressEl.classList.add('text-red-600');
                                            }
                                            if (status.message) {
                                                let errorMsg = `Agent failed: ${status.message}`;
                                                if (status.message.includes('OAuth') || status.message.includes('authenticate')) {
                                                    errorMsg += ' â†’ Go to Settings to authenticate with GitHub.';
                                                }
                                                showErrorNotification(errorMsg, 15000);
                                            }
                                        }
                                    }
                                } catch (err) {
                                    console.error('Status polling error:', err);
                                }
                            }, 2000); // Poll every 2 seconds
                        } else {
                            btn.textContent = 'âŒ Error';
                            btn.classList.add('bg-red-600', 'hover:bg-red-500');
                            btn.classList.remove('bg-sky-600', 'hover:bg-sky-500');
                            btn.disabled = false;
                        }
                    } catch (error) {
                        btn.textContent = 'âŒ Error';
                        btn.classList.add('bg-red-600', 'hover:bg-red-500');
                        btn.classList.remove('bg-sky-600', 'hover:bg-sky-500');
                        console.error('Agent execution error:', error);
                        btn.disabled = false;
                    }
                });
            });
        }
        
        document.getElementById('issues-search').addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            
            const filtered = allIssues.filter(issue => {
                const number = issue.number.toString();
                const title = (issue.title || '').toLowerCase();
                const authorStr = (issue.author && issue.author.login) ? issue.author.login : (typeof issue.author === 'string' ? issue.author : '');
                const author = authorStr.toLowerCase();
                const assigneeStr = (issue.assignees && Array.isArray(issue.assignees))
                    ? issue.assignees.map(a => a.login || a).join(' ')
                    : '';
                const assignee = assigneeStr.toLowerCase();
                const body = (issue.body || '').toLowerCase();
                
                // Check for number match (#123)
                if (query.startsWith('#')) {
                    return number.includes(query.substring(1));
                }
                
                // Freeword search in title, author, assignee, and body
                return title.includes(query) || author.includes(query) || assignee.includes(query) || body.includes(query);
            });
            
            displayFilteredIssues(filtered);
        });

        // View toggle button
        viewToggleBtn.addEventListener('click', () => {
            if (currentView === 'issues') {
                currentView = 'prs';
                viewToggleBtn.textContent = 'View: PRs';
                document.getElementById('issues-list').classList.add('hidden');
                document.getElementById('issues-search').classList.add('hidden');
                prsList.classList.remove('hidden');
                loadGitHubPRs();
            } else {
                currentView = 'issues';
                viewToggleBtn.textContent = 'View: Issues';
                prsList.classList.add('hidden');
                document.getElementById('issues-list').classList.remove('hidden');
                document.getElementById('issues-search').classList.remove('hidden');
                loadGitHubIssues();
            }
        });

        // Load GitHub PRs
        async function loadGitHubPRs() {
            issuesError.classList.add('hidden');
            prsList.innerHTML = '<div class="text-center text-gray-600 text-xs py-2">Loading PRs...</div>';

            try {
                const url = new URL('/api/github/prs', window.location.origin);
                const response = await fetch(url);
                const data = await response.json();

                console.log('PRs response:', data);

                if (response.ok) {
                    issuesOwner = data.owner;
                    issuesRepo = data.repo;
                    if (data.error) {
                        showIssuesError(`Error fetching PRs: ${data.error}`);
                    } else if (data.prs && data.prs.length > 0) {
                        allPRs = data.prs;
                        displayPRs(allPRs);
                    } else {
                        prsList.innerHTML = '<div class="text-center text-gray-600 text-xs py-2">No open PRs found</div>';
                    }
                } else {
                    showIssuesError(data.error || 'Could not fetch PRs');
                }
            } catch (error) {
                console.error('PRs load error:', error);
                showIssuesError('Connection error: ' + error.message);
            }
        }

        function displayPRs(prs) {
            if (prs.length === 0) {
                prsList.innerHTML = '<div class="text-center text-gray-600 text-sm py-4">No PRs found</div>';
                return;
            }

            prsList.innerHTML = prs.map(pr => {
                const prUrl = pr.url || `https://github.com/${issuesOwner}/${issuesRepo}/pull/${pr.number}`;
                const author = (pr.author && pr.author.login) ? pr.author.login : 'unknown';
                
                return `
                    <div class="bg-white p-2 rounded border border-sky-200 hover:bg-sky-100 transition-colors">
                        <div class="flex justify-between items-start gap-2">
                            <div class="flex-1 min-w-0">
                                <div class="font-semibold text-sky-700"><a href="${prUrl}" target="_blank" rel="noopener noreferrer" class="hover:underline">#${pr.number} ${pr.title}</a></div>
                                <div class="text-xs text-gray-500 mt-1">Author: ${author}</div>
                                <div class="text-xs text-gray-500">Branch: ${pr.headRefName || 'unknown'}</div>
                            </div>
                            <button class="pr-review-btn bg-purple-600 hover:bg-purple-500 text-white text-xs px-2 py-1 rounded transition-colors whitespace-nowrap" data-pr-number="${pr.number}" data-pr-title="${pr.title.replace(/"/g, '&quot;')}">
                                ðŸ“ Reviews
                            </button>
                        </div>
                    </div>
                `;
            }).join('');

            // Attach event listeners to review buttons
            document.querySelectorAll('.pr-review-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    const prNumber = btn.dataset.prNumber;
                    const prTitle = btn.dataset.prTitle;
                    await showPRReviews(prNumber, prTitle);
                });
            });
        }

        async function showPRReviews(prNumber, prTitle) {
            currentPRNumber = parseInt(prNumber);
            prReviewsInfo.textContent = `PR #${prNumber}: ${prTitle}`;
            prReviewsContent.innerHTML = '<div class="text-center text-gray-600 text-sm">Loading reviews...</div>';
            prReviewsModal.classList.remove('hidden');

            try {
                const url = new URL('/api/github/pr/reviews', window.location.origin);
                url.searchParams.append('pr_number', prNumber);
                const response = await fetch(url);
                const data = await response.json();

                console.log('Reviews data:', data);

                if (response.ok) {
                    displayReviews(data);
                } else {
                    prReviewsContent.innerHTML = `<div class="text-red-600 text-sm">${data.error || 'Failed to load reviews'}</div>`;
                }
            } catch (error) {
                console.error('Reviews load error:', error);
                prReviewsContent.innerHTML = `<div class="text-red-600 text-sm">Connection error: ${error.message}</div>`;
            }
        }

        function displayReviews(data) {
            const reviews = data.reviews || [];
            const comments = data.comments || [];

            let html = '';

            if (reviews.length === 0 && comments.length === 0) {
                html = '<div class="text-center text-gray-600 text-sm">No reviews or comments yet</div>';
            } else {
                if (reviews.length > 0) {
                    html += '<div class="mb-3"><h3 class="text-sm font-bold text-purple-600 mb-2">Reviews:</h3>';
                    reviews.forEach(review => {
                        const state = review.state || 'COMMENTED';
                        const stateClass = state === 'APPROVED' ? 'bg-green-100 text-green-700' : 
                                         state === 'CHANGES_REQUESTED' ? 'bg-red-100 text-red-700' : 
                                         'bg-gray-100 text-gray-700';
                        const author = (review.author && review.author.login) ? review.author.login : 'unknown';
                        
                        html += `
                            <div class="bg-white p-2 rounded border border-purple-200 mb-2">
                                <div class="flex justify-between items-start mb-1">
                                    <span class="text-xs font-semibold text-gray-700">${author}</span>
                                    <span class="text-xs px-2 py-0.5 rounded ${stateClass}">${state}</span>
                                </div>
                                ${review.body ? `<div class="text-xs text-gray-600 mt-1">${review.body}</div>` : ''}
                            </div>
                        `;
                    });
                    html += '</div>';
                }

                if (comments.length > 0) {
                    html += '<div><h3 class="text-sm font-bold text-purple-600 mb-2">Comments:</h3>';
                    comments.forEach(comment => {
                        const author = (comment.author && comment.author.login) ? comment.author.login : 'unknown';
                        html += `
                            <div class="bg-white p-2 rounded border border-purple-200 mb-2">
                                <div class="text-xs font-semibold text-gray-700 mb-1">${author}</div>
                                <div class="text-xs text-gray-600">${comment.body || '(No comment text)'}</div>
                            </div>
                        `;
                    });
                    html += '</div>';
                }
            }

            prReviewsContent.innerHTML = html;
        }

        prApplyReviewBtn.addEventListener('click', async () => {
            if (!currentPRNumber) return;

            // Collect all review text
            const reviews = prReviewsContent.querySelectorAll('[class*="bg-white"]');
            let reviewText = '';
            reviews.forEach(review => {
                const text = review.textContent.trim();
                if (text) reviewText += text + '\n\n';
            });

            if (!reviewText) {
                showNotification('No review comments to apply');
                return;
            }

            prApplyReviewBtn.disabled = true;
            prApplyReviewBtn.textContent = 'â³ Processing...';

            try {
                // Find the issue number associated with this PR
                const pr = allPRs.find(p => p.number === currentPRNumber);
                let issueNumber = currentPRNumber; // Default to PR number
                
                // Try to extract issue number from PR body
                if (pr && pr.body) {
                    const match = pr.body.match(/(?:Fixes|Closes|Resolves)\s+#(\d+)/i);
                    if (match) {
                        issueNumber = parseInt(match[1]);
                    }
                }

                currentIssueForReview = issueNumber;

                const response = await fetch('/api/agent/apply-review', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        issue_number: issueNumber,
                        pr_number: currentPRNumber,
                        review_text: reviewText
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    showNotification('âœ“ Agent started processing review comments');
                    prReviewsModal.classList.add('hidden');
                    
                    // Poll for status
                    const pollStatus = setInterval(async () => {
                        try {
                            const statusResponse = await fetch(`/api/agent/status?issue_number=${issueNumber}`);
                            const status = await statusResponse.json();
                            
                            if (statusResponse.ok && status) {
                                const progressEl = document.getElementById('pr-review-progress');
                                if (progressEl) {
                                    progressEl.textContent = status.message;
                                    progressEl.classList.remove('hidden');
                                }

                                if (status.status === 'completed') {
                                    clearInterval(pollStatus);
                                    showNotification('âœ“ Review comments applied successfully!');
                                } else if (status.status === 'failed') {
                                    clearInterval(pollStatus);
                                    showNotification('âœ— Failed: ' + status.message);
                                }
                            }
                        } catch (err) {
                            console.error('Status poll error:', err);
                        }
                    }, 2000);

                    setTimeout(() => clearInterval(pollStatus), 300000); // 5 min timeout
                } else {
                    showNotification('âœ— Failed: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Apply review error:', error);
                showNotification('âœ— Error: ' + error.message);
            } finally {
                prApplyReviewBtn.disabled = false;
                prApplyReviewBtn.textContent = 'ðŸ¤– Apply Review Comments with Agent';
            }
        });

        prReviewsModalCloseBtn.addEventListener('click', () => {
            prReviewsModal.classList.add('hidden');
        });

        // Refresh button listener
        document.getElementById('issues-refresh-btn').addEventListener('click', async () => {
            const btn = document.getElementById('issues-refresh-btn');
            btn.disabled = true;
            btn.textContent = 'â³';
            try {
                if (currentView === 'issues') {
                    await loadGitHubIssues();
                } else {
                    await loadGitHubPRs();
                }
            } finally {
                btn.disabled = false;
                btn.textContent = 'ðŸ”„';
            }
        });

        function showIssuesError(message) {
            issuesError.textContent = message;
            issuesError.classList.remove('hidden');
            issuesRepoName.textContent = 'Error';
            issuesRemoteUrl.textContent = '';
        }

        createBranchSubmitBtn.addEventListener('click', createBranch);

        remoteFormCloseBtn.addEventListener('click', () => {
            remoteFormModal.classList.add('hidden');
        });

        remoteFormModal.addEventListener('click', (e) => {
            if (e.target === remoteFormModal) {
                remoteFormModal.classList.add('hidden');
            }
        });

        remoteFormSubmitBtn.addEventListener('click', saveRemote);

        createRepoModal.addEventListener('click', (e) => {
            if (e.target === createRepoModal) {
                createRepoModal.classList.add('hidden');
            }
        });

        createRepoSubmitBtn.addEventListener('click', async () => {
            const repoName = createRepoNameInput.value.trim();
            const subdirs = createRepoSubdirsInput.value.trim();

            if (!repoName) {
                showCreateRepoError('Repository name is required');
                return;
            }

            createRepoSubmitBtn.disabled = true;
            createRepoSubmitBtn.textContent = 'Creating...';
            createRepoError.classList.add('hidden');

            try {
                const response = await fetch('/api/repo/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        repoName: repoName,
                        subdirs: subdirs || ''
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    createRepoModal.classList.add('hidden');
                    createRepoSubmitBtn.disabled = false;
                    createRepoSubmitBtn.textContent = 'Create';
                    
                    // Reload repositories and show success
                    repoModal.classList.remove('hidden');
                    loadRepositories();
                    
                    // Show success message with logs
                    showLog(data.log || ['Repository created successfully']);
                } else {
                    showCreateRepoError(data.error || 'Failed to create repository');
                    createRepoSubmitBtn.disabled = false;
                    createRepoSubmitBtn.textContent = 'Create';
                }
            } catch (error) {
                showCreateRepoError('Network error: ' + error.message);
                createRepoSubmitBtn.disabled = false;
                createRepoSubmitBtn.textContent = 'Create';
            }
        });

        function showCreateRepoError(message) {
            createRepoError.textContent = message;
            createRepoError.classList.remove('hidden');
        }

        async function createIssue() {
            const title = createIssueTitleInput.value.trim();
            const body = createIssueBodyInput.value.trim();
            const labelsStr = createIssueLabelsInput.value.trim();
            
            if (!title) {
                createIssueError.textContent = 'Title is required';
                createIssueError.classList.remove('hidden');
                return;
            }

            createIssueSubmitBtn.disabled = true;
            createIssueSubmitBtn.textContent = 'Creating...';
            createIssueError.classList.add('hidden');

            try {
                const repoPath = getCurrentRepositoryPath();
                const url = new URL('/api/github/issues/create', window.location.origin);
                if (repoPath && repoPath !== '/') {
                    url.searchParams.append('repoPath', repoPath);
                }

                const labels = labelsStr ? labelsStr.split(',').map(l => l.trim()).filter(l => l) : [];

                const response = await fetch(url.toString(), {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        title: title,
                        body: body,
                        labels: labels
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    createIssueModal.classList.add('hidden');
                    createIssueSubmitBtn.disabled = false;
                    createIssueSubmitBtn.textContent = 'Create';
                    
                    // Reload issues list
                    loadGitHubIssues();
                    
                    // Show success notification
                    showNotification(`Issue #${data.number} created successfully!`);
                } else {
                    createIssueError.textContent = data.error || 'Failed to create issue';
                    createIssueError.classList.remove('hidden');
                    createIssueSubmitBtn.disabled = false;
                    createIssueSubmitBtn.textContent = 'Create';
                }
            } catch (error) {
                createIssueError.textContent = 'Network error: ' + error.message;
                createIssueError.classList.remove('hidden');
                createIssueSubmitBtn.disabled = false;
                createIssueSubmitBtn.textContent = 'Create';
            }
        }

        async function loadCommits() {
            try {
                const repoPath = getCurrentRepositoryPath();
                const url = new URL('/api/commits', window.location.origin);
                if (repoPath) {
                    url.searchParams.append('repoPath', repoPath);
                }
                url.searchParams.append('limit', '20');
                const response = await fetch(url.toString());
                const data = await response.json();
                if (response.ok && data.commits) {
                    displayCommits(data.commits);
                } else if (data.error) {
                    commitsList.innerHTML = `<div class="text-center text-red-400 text-sm">${escapeHtml(data.error)}</div>`;
                } else {
                    commitsList.innerHTML = `<div class="text-center text-red-400 text-sm">Failed to load commits</div>`;
                }
            } catch (error) {
                console.error('Commits load error:', error);
                commitsList.innerHTML = `<div class="text-center text-red-400 text-sm">Connection failed: ${escapeHtml(error.message)}</div>`;
            }
        }

        function displayCommits(commits) {
            if (commits.length === 0) {
                commitsList.innerHTML = '<div class="text-center text-gray-600 text-sm">No commits found</div>';
                return;
            }

            commitsList.innerHTML = commits.map(commit => `
                <div class="bg-sky-100 hover:bg-sky-200 rounded px-4 py-3 text-gray-700 text-sm transition-colors">
                    <div class="font-semibold text-sky-600 font-mono text-xs">${escapeHtml(commit.hash.substring(0, 7))}</div>
                    <div class="text-sm mt-1">${escapeHtml(commit.message)}</div>
                    <div class="text-xs text-gray-600 mt-1">${escapeHtml(commit.author)}</div>
                    <div class="text-xs text-gray-500">${escapeHtml(commit.date)}</div>
                </div>
            `).join('');
        }

        async function loadTags() {
            try {
                const repoPath = getCurrentRepositoryPath();
                const url = new URL('/api/tags', window.location.origin);
                if (repoPath) {
                    url.searchParams.append('repoPath', repoPath);
                }
                const response = await fetch(url.toString());
                const data = await response.json();
                if (response.ok && data.tags) {
                    displayTags(data.tags);
                } else if (data.error) {
                    tagsList.innerHTML = `<div class="text-center text-red-400 text-sm">${escapeHtml(data.error)}</div>`;
                } else {
                    tagsList.innerHTML = `<div class="text-center text-red-400 text-sm">Failed to load tags</div>`;
                }
            } catch (error) {
                console.error('Tags load error:', error);
                tagsList.innerHTML = `<div class="text-center text-red-400 text-sm">Connection failed: ${escapeHtml(error.message)}</div>`;
            }
        }

        function displayTags(tags) {
            if (tags.length === 0) {
                tagsList.innerHTML = '<div class="text-center text-gray-600 text-sm">No tags found</div>';
                return;
            }

            tagsList.innerHTML = tags.map(tag => `
                <button class="w-full text-left bg-sky-100 hover:bg-sky-200 px-4 py-3 rounded text-gray-700 text-sm transition-colors"
                        onclick="openPushTagModal('${escapeHtml(tag)}')">
                    <div class="flex justify-between items-center">
                        <div class="font-semibold text-sky-600">${escapeHtml(tag)}</div>
                        <i class="fas fa-cloud-arrow-up text-gray-600"></i>
                    </div>
                </button>
            `).join('');
        }

        async function createTag() {
            const tagName = createTagNameInput.value.trim();
            const message = createTagMessageInput.value.trim();

            if (!tagName) {
                createTagError.textContent = 'Tag name is required';
                createTagError.classList.remove('hidden');
                return;
            }

            try {
                createTagSubmitBtn.disabled = true;
                const response = await fetch('/api/tag/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        tagName: tagName,
                        message: message
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    createTagModal.classList.add('hidden');
                    showNotification(`âœ“ Tag '${escapeHtml(tagName)}' created successfully!`);
                    loadTags();
                } else {
                    createTagError.textContent = data.error || 'Failed to create tag';
                    createTagError.classList.remove('hidden');
                }
            } catch (error) {
                console.error('Create tag error:', error);
                createTagError.textContent = `Error: ${error.message}`;
                createTagError.classList.remove('hidden');
            } finally {
                createTagSubmitBtn.disabled = false;
            }
        }

        function openPushTagModal(tagName) {
            selectedTagForPush = tagName;
            pushTagInfo.innerHTML = `Push tag: <strong>${escapeHtml(tagName)}</strong>`;
            pushTagError.classList.add('hidden');
            pushTagModal.classList.remove('hidden');
            loadRemotesForTag();
        }

        async function loadRemotesForTag() {
            try {
                const repoPath = getCurrentRepositoryPath();
                const url = new URL('/api/remotes', window.location.origin);
                if (repoPath) {
                    url.searchParams.append('repoPath', repoPath);
                }
                const response = await fetch(url.toString());
                const data = await response.json();
                if (response.ok && data.remotes) {
                    pushTagRemote.innerHTML = data.remotes.map(remote => 
                        `<option value="${escapeHtml(remote.name)}">${escapeHtml(remote.name)}</option>`
                    ).join('');
                }
            } catch (error) {
                console.error('Load remotes error:', error);
            }
        }

        async function pushTag() {
            if (!selectedTagForPush) {
                pushTagError.textContent = 'No tag selected';
                pushTagError.classList.remove('hidden');
                return;
            }

            const remote = pushTagRemote.value;

            try {
                pushTagSubmitBtn.disabled = true;
                const url = new URL('/api/tag/push', window.location.origin);
                url.searchParams.append('remote', remote);
                
                const response = await fetch(url.toString(), {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        tagName: selectedTagForPush,
                        all: false
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    pushTagModal.classList.add('hidden');
                    showNotification(`âœ“ Tag pushed successfully!`);
                    loadTags();
                } else {
                    pushTagError.textContent = data.error || 'Failed to push tag';
                    pushTagError.classList.remove('hidden');
                }
            } catch (error) {
                console.error('Push tag error:', error);
                pushTagError.textContent = `Error: ${error.message}`;
                pushTagError.classList.remove('hidden');
            } finally {
                pushTagSubmitBtn.disabled = false;
            }
        }

        function displayGitHubIssues(issues, owner, repo) {
            if (issues.length === 0) {
                issuesList.innerHTML = '<div class="text-center text-gray-600 text-sm">No issues found</div>';
                return;
            }

            // Store issues data for later use
            issuesList.dataset.allIssues = JSON.stringify(issues);

            issuesList.innerHTML = issues.map(issue => `
                <button class="w-full text-left bg-sky-100 hover:bg-sky-200 px-4 py-3 rounded text-gray-700 text-sm transition-colors"
                        onclick="openIssueDetail(${issue.number}, '${escapeHtml(owner)}', '${escapeHtml(repo)}', '${escapeHtml(issue.title)}')">
                    <div class="flex items-start justify-between gap-2">
                        <div class="flex-1">
                            <div class="font-semibold text-sky-600">#${issue.number} ${escapeHtml(issue.title)}</div>
                            <div class="text-xs text-gray-600 mt-1 line-clamp-2">${escapeHtml(issue.body || '(No description)')}</div>
                        </div>
                        <span class="text-xs px-2 py-1 rounded ${issue.state === 'OPEN' ? 'bg-green-100 text-green-700' : 'bg-purple-100 text-purple-700'}">
                            ${issue.state === 'OPEN' ? 'Open' : 'Closed'}
                        </span>
                    </div>
                </button>
            `).join('');
        }

        function openIssueDetail(issueNumber, owner, repo, title) {
            currentIssueData = { issueNumber, owner, repo, title };
            issueDetailTitle.innerHTML = `<span class="text-sky-600">#${issueNumber}</span> ${escapeHtml(title)}`;
            
            // Find the full issue data to show body
            const allIssues = JSON.parse(issuesList.dataset.allIssues || '[]');
            const fullIssue = allIssues.find(i => i.number === issueNumber);
            
            if (fullIssue && fullIssue.body) {
                issueDetailBody.textContent = fullIssue.body;
            } else {
                issueDetailBody.textContent = '(No description)';
            }
            
            issuesModal.classList.add('hidden');
            issueDetailModal.classList.remove('hidden');
        }

        async function triggerGitHubAgent() {
            if (!currentIssueData) {
                showNotification('No issue selected');
                return;
            }

            const { issueNumber, owner, repo, title } = currentIssueData;
            
            issueTriggerAgentBtn.disabled = true;
            issueTriggerAgentBtn.textContent = 'â³ Triggering...';

            try {
                const url = new URL('/api/github/comment', window.location.origin);
                url.searchParams.append('owner', owner);
                url.searchParams.append('repo', repo);
                url.searchParams.append('issue', issueNumber);

                const response = await fetch(url.toString(), {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        body: '/airgit run'
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    showNotification('âœ“ Agent triggered! GitHub Actions will start soon.');
                    issueDetailModal.classList.add('hidden');
                } else {
                    showNotification('âœ— Failed to trigger agent: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Agent trigger error:', error);
                showNotification('âœ— Error: ' + error.message);
            } finally {
                issueTriggerAgentBtn.disabled = false;
                issueTriggerAgentBtn.textContent = 'ðŸ¤– Trigger Agent';
            }
        }

        async function loadRemotes() {
            try {
                const repoPath = getCurrentRepositoryPath();
                const url = new URL('/api/remotes', window.location.origin);
                if (repoPath) {
                    url.searchParams.append('repoPath', repoPath);
                }
                const response = await fetch(url.toString());
                const data = await response.json();
                if (response.ok && data.remotes) {
                    displayRemotes(data.remotes);
                } else if (data.error) {
                    remotesList.innerHTML = `<div class="text-center text-red-400 text-sm">${escapeHtml(data.error)}</div>`;
                } else {
                    remotesList.innerHTML = `<div class="text-center text-red-400 text-sm">Failed to load remotes</div>`;
                }
            } catch (error) {
                console.error('Remotes load error:', error);
                remotesList.innerHTML = `<div class="text-center text-red-400 text-sm">Connection failed: ${escapeHtml(error.message)}</div>`;
            }
        }

        function displayRemotes(remotes) {
            if (remotes.length === 0) {
                remotesList.innerHTML = '<div class="text-center text-gray-600 text-sm">No remotes configured</div>';
                return;
            }

            remotesList.innerHTML = remotes.map(remote => `
                <div class="bg-sky-100 rounded px-4 py-3 text-gray-700 text-sm flex justify-between items-center">
                    <div class="flex-1">
                        <div class="font-semibold text-sky-600">${escapeHtml(remote.name)}</div>
                        <div class="text-xs text-gray-600 truncate">${escapeHtml(remote.url)}</div>
                    </div>
                    <div class="flex gap-2 ml-2">
                        <button class="text-xs bg-sky-600 hover:bg-sky-500 px-2 py-1 rounded text-white transition-colors"
                                onclick="editRemote('${escapeHtml(remote.name)}', '${escapeHtml(remote.url)}')">Edit</button>
                        <button class="text-xs bg-red-500 hover:bg-red-600 px-2 py-1 rounded text-white transition-colors"
                                onclick="removeRemote('${escapeHtml(remote.name)}')">Remove</button>
                    </div>
                </div>
            `).join('');
        }

        function openCreateBranchForm() {
            createBranchNameInput.value = '';
            createBranchCheckout.checked = true;
            createBranchError.classList.add('hidden');
            createBranchSubmitBtn.disabled = false;
            createBranchSubmitBtn.textContent = 'Create';
            createBranchModal.classList.remove('hidden');
            createBranchNameInput.focus();
        }

        async function createBranch() {
            const branchName = createBranchNameInput.value.trim();
            const shouldCheckout = createBranchCheckout.checked;

            if (!branchName) {
                createBranchError.textContent = 'Branch name is required';
                createBranchError.classList.remove('hidden');
                return;
            }

            createBranchSubmitBtn.disabled = true;
            createBranchSubmitBtn.textContent = 'Creating...';
            createBranchError.classList.add('hidden');

            try {
                const repoPath = getCurrentRepositoryPath();
                const url = new URL('/api/branch/create', window.location.origin);
                if (repoPath) {
                    url.searchParams.append('repoPath', repoPath);
                }
                const response = await fetch(url.toString(), {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        branchName: branchName,
                        checkout: shouldCheckout
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    createBranchModal.classList.add('hidden');
                    createBranchSubmitBtn.disabled = false;
                    createBranchSubmitBtn.textContent = 'Create';
                    
                    // Reload branches and status
                    branchModal.classList.remove('hidden');
                    loadBranches();
                    loadStatus();
                    
                    // Show success log
                    showLog(data.log || ['Branch created successfully']);
                } else {
                    createBranchError.textContent = data.error || 'Failed to create branch';
                    createBranchError.classList.remove('hidden');
                    createBranchSubmitBtn.disabled = false;
                    createBranchSubmitBtn.textContent = 'Create';
                }
            } catch (error) {
                createBranchError.textContent = 'Network error: ' + error.message;
                createBranchError.classList.remove('hidden');
                createBranchSubmitBtn.disabled = false;
                createBranchSubmitBtn.textContent = 'Create';
            }
        }

        function openAddRemoteForm() {
            currentEditingRemote = null;
            remoteFormTitle.textContent = 'Add Remote';
            remoteNameInput.value = '';
            remoteUrlInput.value = '';
            remoteFormError.classList.add('hidden');
            remoteFormSubmitBtn.textContent = 'Add';
            remoteNameInput.disabled = false;
            remoteFormModal.classList.remove('hidden');
            remoteNameInput.focus();
        }

        function editRemote(name, url) {
            currentEditingRemote = name;
            remoteFormTitle.textContent = 'Edit Remote';
            remoteNameInput.value = name;
            remoteUrlInput.value = url;
            remoteFormError.classList.add('hidden');
            remoteFormSubmitBtn.textContent = 'Update';
            remoteNameInput.disabled = true;
            remoteFormModal.classList.remove('hidden');
            remoteUrlInput.focus();
        }

        async function removeRemote(name) {
            if (!confirm(`Are you sure you want to remove the remote "${name}"?`)) {
                return;
            }

            try {
                const repoPath = getCurrentRepositoryPath();
                const url = new URL('/api/remote/remove', window.location.origin);
                if (repoPath) {
                    url.searchParams.append('repoPath', repoPath);
                }
                const response = await fetch(url.toString(), {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: name })
                });

                const data = await response.json();

                if (response.ok) {
                    loadRemotes();
                } else {
                    alert(`Error: ${data.error || 'Failed to remove remote'}`);
                }
            } catch (error) {
                alert(`Connection error: ${error.message}`);
            }
        }

        async function saveRemote() {
            const name = remoteNameInput.value.trim();
            const url = remoteUrlInput.value.trim();

            if (!name || !url) {
                remoteFormError.textContent = 'Remote name and URL are required';
                remoteFormError.classList.remove('hidden');
                return;
            }

            remoteFormSubmitBtn.disabled = true;
            const originalText = remoteFormSubmitBtn.textContent;
            remoteFormSubmitBtn.textContent = 'Saving...';
            remoteFormError.classList.add('hidden');

            try {
                const repoPath = getCurrentRepositoryPath();
                let endpoint = '/api/remote/add';
                if (currentEditingRemote) {
                    endpoint = '/api/remote/update';
                }

                const apiUrl = new URL(endpoint, window.location.origin);
                if (repoPath) {
                    apiUrl.searchParams.append('repoPath', repoPath);
                }

                const response = await fetch(apiUrl.toString(), {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: name, url: url })
                });

                const data = await response.json();

                if (response.ok) {
                    remoteFormModal.classList.add('hidden');
                    remoteFormSubmitBtn.disabled = false;
                    remoteFormSubmitBtn.textContent = originalText;
                    loadRemotes();
                } else {
                    remoteFormError.textContent = data.error || 'Failed to save remote';
                    remoteFormError.classList.remove('hidden');
                    remoteFormSubmitBtn.disabled = false;
                    remoteFormSubmitBtn.textContent = originalText;
                }
            } catch (error) {
                remoteFormError.textContent = 'Network error: ' + error.message;
                remoteFormError.classList.remove('hidden');
                remoteFormSubmitBtn.disabled = false;
                remoteFormSubmitBtn.textContent = originalText;
            }
        }

        closeSuccessBtn.addEventListener('click', () => {
            successMessage.classList.add('hidden');
            resetUI();
        });

        pushButton.addEventListener('click', async () => {
            console.log('PUSH button clicked');
            pushButton.disabled = true;
            pullButton.disabled = true;
            buttonText.classList.add('hidden');
            loadingSpinner.classList.remove('hidden');
            successMessage.classList.add('hidden');
            errorMessage.classList.add('hidden');
            logContainer.classList.add('hidden');

            try {
                const repoPath = getCurrentRepositoryPath();
                const url = new URL('/api/push', window.location.origin);
                if (repoPath) {
                    url.searchParams.append('repoPath', repoPath);
                }
                const response = await fetch(url.toString(), { method: 'POST' });
                const data = await response.json();

                if (response.ok) {
                    console.log('PUSH: response.ok is true, data:', data);
                    loadingSpinner.classList.add('hidden');
                    successMessage.classList.remove('hidden');
                    console.log('PUSH: success message should be visible now');
                    showLog(data.log || ['Push completed']);
                    loadStatus();
                } else {
                    console.log('PUSH: response failed with status', response.status, 'data:', data);
                    loadingSpinner.classList.add('hidden');
                    successMessage.classList.remove('hidden');
                    showError(data.error || 'Push failed');
                    showLog(data.log || []);
                    loadStatus();
                }
            } catch (error) {
                console.error('Push error:', error);
                showError('Network error: ' + error.message);
                resetUI();
            }
        });

        pullButton.addEventListener('click', async () => {
            pushButton.disabled = true;
            pullButton.disabled = true;
            pullButtonText.classList.add('hidden');
            pullLoadingSpinner.classList.remove('hidden');
            successMessage.classList.add('hidden');
            errorMessage.classList.add('hidden');
            logContainer.classList.add('hidden');

            try {
                const repoPath = getCurrentRepositoryPath();
                const url = new URL('/api/pull', window.location.origin);
                if (repoPath) {
                    url.searchParams.append('repoPath', repoPath);
                }
                const response = await fetch(url.toString(), { method: 'POST' });
                const data = await response.json();

                if (response.ok) {
                    pullLoadingSpinner.classList.add('hidden');
                    successMessage.classList.remove('hidden');
                    if (data.log) {
                        showLog(data.log);
                    }
                    loadStatus();
                } else {
                    showError(data.error || 'Pull failed');
                    if (data.log) {
                        showLog(data.log);
                    }
                    resetUI();
                }
            } catch (error) {
                showError('Network error: ' + error.message);
                resetUI();
            }
        });

        // Systemd Registration Features
        const settingsBtn = document.getElementById('settings-btn');
        const settingsModal = document.getElementById('settings-modal');
        const settingsModalCloseBtn = document.getElementById('settings-modal-close-btn');
        const systemdRegisterBtn = document.getElementById('systemd-register-btn');
        const systemdBtnText = document.getElementById('systemd-btn-text');
        const systemdSpinner = document.getElementById('systemd-spinner');
        const systemdStatusBadge = document.getElementById('systemd-status-badge');
        const systemdStatusMessage = document.getElementById('systemd-status-message');

        // GitHub OAuth Features
        const githubAuthBtn = document.getElementById('github-auth-btn');
        const githubAuthBtnText = document.getElementById('github-auth-btn-text');
        const githubAuthSpinner = document.getElementById('github-auth-spinner');
        const githubAuthBadge = document.getElementById('github-auth-badge');
        const githubAuthMessage = document.getElementById('github-auth-message');
        
        let authPollingInterval = null;

        async function loadGitHubAuthStatus() {
            try {
                const response = await fetch('/api/github/auth/status');
                const data = await response.json();

                if (data.authenticated) {
                    githubAuthBadge.textContent = 'âœ“ Authenticated';
                    githubAuthBadge.className = 'px-2 py-1 rounded text-xs font-medium bg-sky-100 text-sky-600';
                    githubAuthMessage.textContent = 'âœ“ GitHub CLI is authenticated';
                    githubAuthBtn.disabled = true;
                    githubAuthBtn.className = 'w-full bg-sky-200 px-4 py-2 rounded text-white text-sm font-medium opacity-50 cursor-not-allowed';
                    githubAuthBtnText.textContent = 'âœ“ Authenticated';
                    
                    // Stop polling if running
                    if (authPollingInterval) {
                        clearInterval(authPollingInterval);
                        authPollingInterval = null;
                    }
                } else {
                    githubAuthBadge.textContent = 'Not Authenticated';
                    githubAuthBadge.className = 'px-2 py-1 rounded text-xs font-medium bg-yellow-100 text-yellow-700';
                    githubAuthMessage.textContent = 'Agent features require GitHub authentication';
                    githubAuthBtn.disabled = false;
                    githubAuthBtn.className = 'w-full bg-sky-600 hover:bg-sky-500 px-4 py-2 rounded text-white text-sm font-medium transition-colors';
                    githubAuthBtnText.textContent = 'Authenticate with GitHub';
                }
            } catch (error) {
                console.error('Error loading GitHub auth status:', error);
                githubAuthBadge.textContent = 'Error';
                githubAuthBadge.className = 'px-2 py-1 rounded text-xs font-medium bg-red-100 text-red-700';
                githubAuthMessage.textContent = 'Failed to check authentication status';
            }
        }
        
        function stopAuthPolling() {
            if (authPollingInterval) {
                clearInterval(authPollingInterval);
                authPollingInterval = null;
                log.Printf("Stopped auth polling");
            }
        }

        githubAuthBtn.addEventListener('click', async () => {
            // If polling is active, stop it (Cancel button behavior)
            if (authPollingInterval) {
                stopAuthPolling();
                githubAuthBadge.textContent = 'Not Authenticated';
                githubAuthBadge.className = 'px-2 py-1 rounded text-xs font-medium bg-yellow-100 text-yellow-700';
                githubAuthMessage.textContent = 'Authentication cancelled';
                githubAuthBtn.disabled = false;
                githubAuthBtn.className = 'w-full bg-sky-600 hover:bg-sky-500 px-4 py-2 rounded text-white text-sm font-medium transition-colors';
                githubAuthBtnText.textContent = 'Authenticate with GitHub';
                githubAuthBtnText.classList.remove('hidden');
                githubAuthSpinner.classList.add('hidden');
                return;
            }
            
            if (githubAuthBtn.disabled) return;

            githubAuthBtn.disabled = true;
            githubAuthBtnText.classList.add('hidden');
            githubAuthSpinner.classList.remove('hidden');
            githubAuthMessage.textContent = 'Starting GitHub authentication...';

            try {
                const response = await fetch('/api/github/auth/login', { method: 'POST' });
                const data = await response.json();

                if (data.success && data.device_flow) {
                    // DON'T open browser yet - wait for user to copy code first
                    
                    // Show device code with copy button
                    githubAuthBadge.textContent = 'Ready to Authenticate';
                    githubAuthBadge.className = 'px-2 py-1 rounded text-xs font-medium bg-blue-100 text-blue-700';
                    
                    githubAuthMessage.innerHTML = `
                        <div class="space-y-3">
                            <p class="font-semibold text-blue-700">Step 1: Copy your code</p>
                            <div class="bg-white p-3 rounded border border-sky-300">
                                <p class="text-xs mb-2">Your one-time code:</p>
                                <p id="github-code-display" class="font-mono text-2xl font-bold text-sky-700 select-all text-center">${data.code}</p>
                                <button id="copy-code-btn" class="mt-2 w-full bg-sky-600 hover:bg-sky-700 px-3 py-2 rounded text-sm text-white font-medium">
                                    ðŸ“‹ Copy Code & Open GitHub
                                </button>
                            </div>
                            <p class="text-xs text-gray-600">Or <a href="${data.url}" target="_blank" class="text-sky-600 underline" onclick="event.preventDefault(); document.getElementById('copy-code-btn').click();">open GitHub manually</a></p>
                        </div>
                    `;
                    
                    githubAuthBtn.disabled = false;
                    githubAuthBtn.className = 'w-full bg-red-600 hover:bg-red-500 px-4 py-2 rounded text-white text-sm font-medium transition-colors';
                    githubAuthBtnText.textContent = 'âŒ Cancel';
                    githubAuthBtnText.classList.remove('hidden');
                    githubAuthSpinner.classList.add('hidden');
                    
                    // Add click handler for copy button
                    setTimeout(() => {
                        const copyBtn = document.getElementById('copy-code-btn');
                        if (copyBtn) {
                            copyBtn.addEventListener('click', async () => {
                                // Copy code to clipboard
                                try {
                                    await navigator.clipboard.writeText(data.code);
                                    copyBtn.textContent = 'âœ“ Copied! Opening GitHub...';
                                    copyBtn.disabled = true;
                                    copyBtn.className = 'mt-2 w-full bg-green-600 px-3 py-2 rounded text-sm text-white font-medium cursor-not-allowed';
                                    
                                    // Wait a moment then open browser
                                    setTimeout(() => {
                                        window.open(data.url, '_blank');
                                        
                                        // Update UI to show waiting state
                                        githubAuthBadge.textContent = 'Waiting for Auth...';
                                        githubAuthBadge.className = 'px-2 py-1 rounded text-xs font-medium bg-yellow-100 text-yellow-700 animate-pulse';
                                        
                                        githubAuthMessage.innerHTML = `
                                            <div class="space-y-3">
                                                <p class="font-semibold text-green-700">âœ“ Code copied & browser opened!</p>
                                                <div class="bg-white p-3 rounded border border-sky-300">
                                                    <p class="text-xs mb-2">Paste this code in GitHub:</p>
                                                    <p class="font-mono text-2xl font-bold text-sky-700 select-all text-center">${data.code}</p>
                                                </div>
                                                <div class="flex items-center justify-center space-x-2 text-xs text-sky-700">
                                                    <svg class="animate-spin h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                                    </svg>
                                                    <span>Waiting for authentication...</span>
                                                </div>
                                            </div>
                                        `;
                                        
                                        // Start polling
                                        startAuthPolling(data.code);
                                    }, 500);
                                    
                                } catch (err) {
                                    console.error('Failed to copy:', err);
                                    copyBtn.textContent = 'âŒ Copy failed - Opening GitHub anyway...';
                                    setTimeout(() => {
                                        window.open(data.url, '_blank');
                                        startAuthPolling(data.code);
                                    }, 1000);
                                }
                            });
                        }
                    }, 100);
                    
                } else if (data.success) {
                    githubAuthBadge.textContent = 'âœ“ Authenticated';
                    githubAuthBadge.className = 'px-2 py-1 rounded text-xs font-medium bg-sky-100 text-sky-600';
                    githubAuthMessage.textContent = 'âœ“ Authentication successful!';
                    githubAuthBtn.disabled = true;
                    githubAuthBtn.className = 'w-full bg-sky-200 px-4 py-2 rounded text-white text-sm font-medium opacity-50 cursor-not-allowed';
                    githubAuthBtnText.textContent = 'âœ“ Authenticated';
                    githubAuthSpinner.classList.add('hidden');
                } else {
                    githubAuthBadge.textContent = 'Failed';
                    githubAuthBadge.className = 'px-2 py-1 rounded text-xs font-medium bg-red-100 text-red-700';
                    let errorMsg = 'âœ— Authentication failed: ' + (data.error || data.message || 'Unknown error');
                    if (data.output) {
                        errorMsg += '<br><br><details class="text-xs"><summary>Debug Info</summary><pre class="mt-2 p-2 bg-gray-100 rounded overflow-auto">' + data.output + '</pre></details>';
                    }
                    githubAuthMessage.innerHTML = errorMsg;
                    githubAuthBtn.disabled = false;
                    githubAuthBtn.className = 'w-full bg-sky-600 hover:bg-sky-500 px-4 py-2 rounded text-white text-sm font-medium transition-colors';
                    githubAuthBtnText.classList.remove('hidden');
                    githubAuthSpinner.classList.add('hidden');
                }
            } catch (error) {
                console.error('Error authenticating with GitHub:', error);
                githubAuthBadge.textContent = 'Error';
                githubAuthBadge.className = 'px-2 py-1 rounded text-xs font-medium bg-red-100 text-red-700';
                githubAuthMessage.textContent = 'âœ— Network error: ' + error.message;
                githubAuthBtn.disabled = false;
                githubAuthBtn.className = 'w-full bg-sky-600 hover:bg-sky-500 px-4 py-2 rounded text-white text-sm font-medium transition-colors';
                githubAuthBtnText.classList.remove('hidden');
                githubAuthSpinner.classList.add('hidden');
            }
        });
        
        function startAuthPolling(code) {
            let pollCount = 0;
            const maxPolls = 60; // 5 minutes (60 * 5 seconds)
            
            authPollingInterval = setInterval(async () => {
                pollCount++;
                console.log(`Polling auth status (${pollCount}/${maxPolls})`);
                
                try {
                    const statusResponse = await fetch('/api/github/auth/status');
                    const statusData = await statusResponse.json();
                    
                    if (statusData.authenticated) {
                        // Success!
                        clearInterval(authPollingInterval);
                        authPollingInterval = null;
                        
                        githubAuthBadge.textContent = 'âœ“ Authenticated';
                        githubAuthBadge.className = 'px-2 py-1 rounded text-xs font-medium bg-green-100 text-green-700';
                        githubAuthMessage.innerHTML = '<p class="font-semibold text-green-700 text-lg">âœ“ GitHub authentication successful!</p>';
                        githubAuthBtn.disabled = true;
                        githubAuthBtn.className = 'w-full bg-sky-200 px-4 py-2 rounded text-white text-sm font-medium opacity-50 cursor-not-allowed';
                        githubAuthBtnText.textContent = 'âœ“ Authenticated';
                        githubAuthBtnText.classList.remove('hidden');
                        githubAuthSpinner.classList.add('hidden');
                    } else if (pollCount >= maxPolls) {
                        // Timeout
                        clearInterval(authPollingInterval);
                        authPollingInterval = null;
                        
                        githubAuthBadge.textContent = 'Timeout';
                        githubAuthBadge.className = 'px-2 py-1 rounded text-xs font-medium bg-red-100 text-red-700';
                        githubAuthMessage.textContent = 'â±ï¸ Authentication timeout. Please try again.';
                        githubAuthBtn.disabled = false;
                        githubAuthBtn.className = 'w-full bg-sky-600 hover:bg-sky-500 px-4 py-2 rounded text-white text-sm font-medium transition-colors';
                        githubAuthBtnText.textContent = 'Authenticate with GitHub';
                        githubAuthBtnText.classList.remove('hidden');
                        githubAuthSpinner.classList.add('hidden');
                    }
                } catch (err) {
                    console.error('Polling error:', err);
                }
            }, 5000); // Poll every 5 seconds
        }

        // Settings modal event listeners
        settingsBtn.addEventListener('click', () => {
            settingsModal.classList.remove('hidden');
            loadSystemdStatus();
            loadServiceStatus();
            loadGitHubAuthStatus();
            initializePWAInstall();
        });

        settingsModalCloseBtn.addEventListener('click', () => {
            settingsModal.classList.add('hidden');
        });

        // Close settings modal when clicking outside
        settingsModal.addEventListener('click', (e) => {
            if (e.target === settingsModal) {
                settingsModal.classList.add('hidden');
            }
        });

        async function loadSystemdStatus() {
            try {
                const response = await fetch('/api/systemd/status');
                const data = await response.json();

                if (data.registered) {
                    systemdStatusBadge.textContent = 'âœ“ Registered';
                    systemdStatusBadge.className = 'px-2 py-1 rounded text-xs font-medium bg-sky-100 text-sky-600';
                    systemdStatusMessage.textContent = 'AirGit is registered with systemd and will auto-start on login.';
                    systemdRegisterBtn.disabled = true;
                    systemdRegisterBtn.className = 'w-full bg-sky-200 px-4 py-2 rounded text-white text-sm font-medium opacity-50 cursor-not-allowed';
                    systemdBtnText.textContent = 'Already Registered';
                } else {
                    systemdStatusBadge.textContent = 'Not Registered';
                    systemdStatusBadge.className = 'px-2 py-1 rounded text-xs font-medium bg-sky-100 text-gray-600';
                    systemdStatusMessage.textContent = 'Click the button below to register AirGit for auto-start.';
                    systemdRegisterBtn.disabled = false;
                    systemdRegisterBtn.className = 'w-full bg-sky-600 hover:bg-sky-500 px-4 py-2 rounded text-white text-sm font-medium transition-colors';
                    systemdBtnText.textContent = 'Register with Systemd';
                }
            } catch (error) {
                console.error('Error checking systemd status:', error);
                systemdStatusBadge.textContent = 'Error';
                systemdStatusBadge.className = 'px-2 py-1 rounded text-xs font-medium bg-red-100 text-red-700';
                systemdStatusMessage.textContent = 'Could not check registration status.';
            }
        }

        systemdRegisterBtn.addEventListener('click', async () => {
            systemdRegisterBtn.disabled = true;
            systemdBtnText.classList.add('hidden');
            systemdSpinner.classList.remove('hidden');

            try {
                const response = await fetch('/api/systemd/register', { method: 'POST' });
                const data = await response.json();

                if (response.ok && data.success) {
                    // Show success and inform about automatic restart
                    systemdStatusBadge.textContent = 'âœ“ Registered';
                    systemdStatusBadge.className = 'px-2 py-1 rounded text-xs font-medium bg-sky-100 text-sky-600';
                    systemdStatusMessage.textContent = 'âœ“ Successfully registered! Restarting via systemd...';
                    systemdRegisterBtn.disabled = true;
                    systemdRegisterBtn.className = 'w-full bg-sky-200 px-4 py-2 rounded text-white text-sm font-medium opacity-50 cursor-not-allowed';
                    systemdBtnText.textContent = 'Already Registered';
                    systemdSpinner.classList.add('hidden');
                    
                    // Show message about reconnection
                    setTimeout(() => {
                        systemdStatusMessage.textContent = 'âœ“ Registered! Service is now running via systemd. Reconnecting...';
                        // Attempt to reconnect after a moment
                        setTimeout(() => {
                            window.location.reload();
                        }, 2000);
                    }, 1000);
                } else if (response.status === 409) {
                    // Already registered
                    systemdStatusBadge.textContent = 'âœ“ Registered';
                    systemdStatusBadge.className = 'px-2 py-1 rounded text-xs font-medium bg-sky-100 text-sky-600';
                    systemdStatusMessage.textContent = 'AirGit is already registered with systemd.';
                    systemdRegisterBtn.disabled = true;
                    systemdRegisterBtn.className = 'w-full bg-sky-200 px-4 py-2 rounded text-white text-sm font-medium opacity-50 cursor-not-allowed';
                    systemdBtnText.textContent = 'Already Registered';
                    systemdSpinner.classList.add('hidden');
                } else {
                    // Error
                    systemdStatusMessage.textContent = 'âœ— Error: ' + (data.error || 'Failed to register');
                    systemdStatusBadge.textContent = 'Error';
                    systemdStatusBadge.className = 'px-2 py-1 rounded text-xs font-medium bg-red-100 text-red-700';
                    systemdBtnText.classList.remove('hidden');
                    systemdSpinner.classList.add('hidden');
                    systemdRegisterBtn.disabled = false;
                    systemdRegisterBtn.className = 'w-full bg-sky-600 hover:bg-sky-500 px-4 py-2 rounded text-white text-sm font-medium transition-colors';
                }
            } catch (error) {
                console.error('Error registering with systemd:', error);
                systemdStatusMessage.textContent = 'âœ— Network error: ' + error.message;
                systemdStatusBadge.textContent = 'Error';
                systemdStatusBadge.className = 'px-2 py-1 rounded text-xs font-medium bg-red-100 text-red-700';
                systemdBtnText.classList.remove('hidden');
                systemdSpinner.classList.add('hidden');
                systemdRegisterBtn.disabled = false;
                systemdRegisterBtn.className = 'w-full bg-sky-600 hover:bg-sky-500 px-4 py-2 rounded text-white text-sm font-medium transition-colors';
            }
        });

        // Service Status Features
        const serviceStartBtn = document.getElementById('service-start-btn');
        const serviceBtnText = document.getElementById('service-btn-text');
        const serviceSpinner = document.getElementById('service-spinner');
        const serviceStatusBadge = document.getElementById('service-status-badge');
        const serviceStatusMessage = document.getElementById('service-status-message');

        async function loadServiceStatus() {
            try {
                const response = await fetch('/api/systemd/service-status');
                const data = await response.json();

                if (!data.registered) {
                    // Service not registered
                    serviceStatusBadge.textContent = 'Not Registered';
                    serviceStatusBadge.className = 'px-2 py-1 rounded text-xs font-medium bg-sky-100 text-gray-600';
                    serviceStatusMessage.textContent = 'Service must be registered first.';
                    serviceStartBtn.disabled = true;
                    serviceStartBtn.className = 'w-full bg-sky-200 px-4 py-2 rounded text-white text-sm font-medium opacity-50 cursor-not-allowed';
                    serviceBtnText.textContent = 'Register First';
                } else if (data.running) {
                    // Service is running
                    serviceStatusBadge.textContent = 'âœ“ Running';
                    serviceStatusBadge.className = 'px-2 py-1 rounded text-xs font-medium bg-sky-100 text-sky-600';
                    serviceStatusMessage.textContent = 'Service is running via systemd.';
                    serviceStartBtn.disabled = true;
                    serviceStartBtn.className = 'w-full bg-sky-200 px-4 py-2 rounded text-white text-sm font-medium opacity-50 cursor-not-allowed';
                    serviceBtnText.textContent = 'Already Running';
                } else {
                    // Service is registered but not running
                    serviceStatusBadge.textContent = 'Stopped';
                    serviceStatusBadge.className = 'px-2 py-1 rounded text-xs font-medium bg-amber-100 text-amber-700';
                    serviceStatusMessage.textContent = 'Service is registered but not running. Click below to start.';
                    serviceStartBtn.disabled = false;
                    serviceStartBtn.className = 'w-full bg-sky-600 hover:bg-sky-500 px-4 py-2 rounded text-white text-sm font-medium transition-colors';
                    serviceBtnText.textContent = 'Start Service';
                }
            } catch (error) {
                console.error('Error checking service status:', error);
                serviceStatusBadge.textContent = 'Error';
                serviceStatusBadge.className = 'px-2 py-1 rounded text-xs font-medium bg-red-100 text-red-700';
                serviceStatusMessage.textContent = 'Could not check service status.';
            }
        }

        serviceStartBtn.addEventListener('click', async () => {
            serviceStartBtn.disabled = true;
            serviceBtnText.classList.add('hidden');
            serviceSpinner.classList.remove('hidden');

            try {
                const response = await fetch('/api/systemd/service-start', { method: 'POST' });
                const data = await response.json();

                if (response.ok && data.success) {
                    // Success
                    serviceStatusBadge.textContent = 'âœ“ Running';
                    serviceStatusBadge.className = 'px-2 py-1 rounded text-xs font-medium bg-sky-100 text-sky-600';
                    serviceStatusMessage.textContent = 'âœ“ Service started successfully!';
                    serviceStartBtn.disabled = true;
                    serviceStartBtn.className = 'w-full bg-sky-200 px-4 py-2 rounded text-white text-sm font-medium opacity-50 cursor-not-allowed';
                    serviceBtnText.textContent = 'Already Running';
                    serviceSpinner.classList.add('hidden');
                } else if (response.status === 409) {
                    // Already running
                    serviceStatusBadge.textContent = 'âœ“ Running';
                    serviceStatusBadge.className = 'px-2 py-1 rounded text-xs font-medium bg-sky-100 text-sky-600';
                    serviceStatusMessage.textContent = 'Service is already running.';
                    serviceStartBtn.disabled = true;
                    serviceStartBtn.className = 'w-full bg-sky-200 px-4 py-2 rounded text-white text-sm font-medium opacity-50 cursor-not-allowed';
                    serviceBtnText.textContent = 'Already Running';
                    serviceSpinner.classList.add('hidden');
                } else {
                    // Error
                    serviceStatusMessage.textContent = 'âœ— Error: ' + (data.error || 'Failed to start service');
                    serviceStatusBadge.textContent = 'Error';
                    serviceStatusBadge.className = 'px-2 py-1 rounded text-xs font-medium bg-red-100 text-red-700';
                    serviceBtnText.classList.remove('hidden');
                    serviceSpinner.classList.add('hidden');
                    serviceStartBtn.disabled = false;
                    serviceStartBtn.className = 'w-full bg-sky-600 hover:bg-sky-500 px-4 py-2 rounded text-white text-sm font-medium transition-colors';
                }
            } catch (error) {
                console.error('Error starting service:', error);
                serviceStatusMessage.textContent = 'âœ— Network error: ' + error.message;
                serviceStatusBadge.textContent = 'Error';
                serviceStatusBadge.className = 'px-2 py-1 rounded text-xs font-medium bg-red-100 text-red-700';
                serviceBtnText.classList.remove('hidden');
                serviceSpinner.classList.add('hidden');
                serviceStartBtn.disabled = false;
                serviceStartBtn.className = 'w-full bg-sky-600 hover:bg-sky-500 px-4 py-2 rounded text-white text-sm font-medium transition-colors';
            }
        });

        // Rebuild & Restart Features
        const rebuildRestartBtn = document.getElementById('rebuild-restart-btn');
        const rebuildBtnText = document.getElementById('rebuild-btn-text');
        const rebuildSpinner = document.getElementById('rebuild-spinner');
        const rebuildStatusBadge = document.getElementById('rebuild-status-badge');
        const rebuildStatusMessage = document.getElementById('rebuild-status-message');

        rebuildRestartBtn.addEventListener('click', async () => {
            rebuildRestartBtn.disabled = true;
            rebuildBtnText.classList.add('hidden');
            rebuildSpinner.classList.remove('hidden');

            try {
                const response = await fetch('/api/systemd/rebuild-restart', { method: 'POST' });
                const data = await response.json();

                if (response.ok && data.success) {
                    // Success
                    rebuildStatusBadge.textContent = 'âœ“ Success';
                    rebuildStatusBadge.className = 'px-2 py-1 rounded text-xs font-medium bg-sky-100 text-sky-600';
                    rebuildStatusMessage.textContent = 'âœ“ Build successful and service restarted!';
                    rebuildRestartBtn.disabled = true;
                    rebuildRestartBtn.className = 'w-full bg-sky-200 px-4 py-2 rounded text-white text-sm font-medium opacity-50 cursor-not-allowed';
                    rebuildBtnText.textContent = 'âœ“ Done';
                    rebuildSpinner.classList.add('hidden');
                    
                    // Show countdown and reload browser after 3 seconds
                    let countdown = 3;
                    rebuildStatusMessage.textContent = `âœ“ Build successful! Reloading in ${countdown}s...`;
                    const countdownInterval = setInterval(() => {
                        countdown--;
                        if (countdown > 0) {
                            rebuildStatusMessage.textContent = `âœ“ Build successful! Reloading in ${countdown}s...`;
                        } else {
                            clearInterval(countdownInterval);
                            rebuildStatusMessage.textContent = 'ðŸ”„ Reloading...';
                            window.location.reload();
                        }
                    }, 1000);
                } else {
                    // Error
                    rebuildStatusMessage.textContent = 'âœ— Error: ' + (data.error || 'Build or restart failed');
                    if (data.details) {
                        rebuildStatusMessage.textContent += '\n' + data.details.substring(0, 200);
                    }
                    rebuildStatusBadge.textContent = 'Error';
                    rebuildStatusBadge.className = 'px-2 py-1 rounded text-xs font-medium bg-red-100 text-red-700';
                    rebuildBtnText.classList.remove('hidden');
                    rebuildSpinner.classList.add('hidden');
                    rebuildRestartBtn.disabled = false;
                    rebuildRestartBtn.className = 'w-full bg-sky-600 hover:bg-sky-500 px-4 py-2 rounded text-white text-sm font-medium transition-colors';
                }
            } catch (error) {
                console.error('Error rebuilding and restarting:', error);
                rebuildStatusMessage.textContent = 'âœ— Network error: ' + error.message;
                rebuildStatusBadge.textContent = 'Error';
                rebuildStatusBadge.className = 'px-2 py-1 rounded text-xs font-medium bg-red-100 text-red-700';
                rebuildBtnText.classList.remove('hidden');
                rebuildSpinner.classList.add('hidden');
                rebuildRestartBtn.disabled = false;
                rebuildRestartBtn.className = 'w-full bg-sky-600 hover:bg-sky-500 px-4 py-2 rounded text-white text-sm font-medium transition-colors';
            }
        });

        // PWA Install Features
        let deferredPrompt = null;
        let pwaPromptShown = false;
        let promptListenerActive = true;
        
        const pwaSection = document.getElementById('pwa-section');
        const pwaInstallBtn = document.getElementById('pwa-install-btn');
        const pwaBtnText = document.getElementById('pwa-btn-text');
        const pwaSpinner = document.getElementById('pwa-spinner');
        const pwaStatusBadge = document.getElementById('pwa-status-badge');
        const pwaStatusMessage = document.getElementById('pwa-status-message');

        // Multiple listeners for beforeinstallprompt to catch it at any time
        function setupBeforeInstallPromptListener() {
            window.addEventListener('beforeinstallprompt', (e) => {
                if (promptListenerActive) {
                    console.log('âœ“ beforeinstallprompt event captured');
                    e.preventDefault();
                    deferredPrompt = e;
                    pwaPromptShown = false;
                    showReadyState();
                }
            });
        }

        setupBeforeInstallPromptListener();

        // Listen for successful installation
        window.addEventListener('appinstalled', () => {
            console.log('PWA installed successfully');
            deferredPrompt = null;
            pwaPromptShown = true;
            showInstalledState();
        });

        async function initializePWAInstall() {
            console.log('Initializing PWA Install... deferredPrompt:', !!deferredPrompt);
            try {
                const isStandalone = window.matchMedia('(display-mode: standalone)').matches;
                console.log('Is Standalone:', isStandalone);

                // Check if already installed
                if (isStandalone) {
                    console.log('App is running standalone');
                    showInstalledState();
                    return;
                }

                // Check installed related apps (iOS, Samsung, etc.)
                try {
                    const installed = await navigator.getInstalledRelatedApps();
                    console.log('Installed related apps:', installed);
                    if (installed && installed.length > 0) {
                        showInstalledState();
                        return;
                    }
                } catch (e) {
                    console.log('getInstalledRelatedApps not available:', e.message);
                }

                // If beforeinstallprompt is captured, show ready state
                if (deferredPrompt) {
                    console.log('Showing ready state - beforeinstallprompt available');
                    showReadyState();
                } else {
                    console.log('beforeinstallprompt not yet captured, but may come later');
                    showReadyState();
                }
            } catch (error) {
                console.error('Error checking PWA status:', error);
                showReadyState();
            }
        }

        function showReadyState() {
            console.log('Showing READY state');
            pwaStatusBadge.textContent = 'âœ“ Ready';
            pwaStatusBadge.className = 'px-2 py-1 rounded text-xs font-medium bg-sky-100 text-sky-600';
            
            const isSecure = window.location.protocol === 'https:' || 
                           window.location.hostname === 'localhost' || 
                           window.location.hostname === '127.0.0.1';
            
            if (isSecure) {
                pwaStatusMessage.textContent = 'Install AirGit as an app for quick access from your home screen.';
            } else {
                pwaStatusMessage.textContent = 'Click "Install App" to add AirGit to your home screen. Works on all browsers!';
            }
            
            pwaInstallBtn.disabled = false;
            pwaInstallBtn.className = 'w-full bg-sky-600 hover:bg-sky-500 px-4 py-2 rounded text-white text-sm font-medium transition-colors';
            pwaBtnText.textContent = 'Install App';
        }

        function showInstalledState() {
            console.log('Showing INSTALLED state');
            pwaStatusBadge.textContent = 'âœ“ Installed';
            pwaStatusBadge.className = 'px-2 py-1 rounded text-xs font-medium bg-sky-100 text-sky-600';
            pwaStatusMessage.textContent = 'AirGit is already installed! You can open it from your home screen or app drawer.';
            pwaInstallBtn.disabled = true;
            pwaInstallBtn.className = 'w-full bg-sky-300 cursor-not-allowed px-4 py-2 rounded text-white text-sm font-medium opacity-60';
            pwaBtnText.textContent = 'Already Installed';
        }

        pwaInstallBtn.addEventListener('click', async () => {
            console.log('Install button clicked. deferredPrompt:', !!deferredPrompt);
            
            pwaInstallBtn.disabled = true;
            pwaBtnText.classList.add('hidden');
            pwaSpinner.classList.remove('hidden');
            
            try {
                // If beforeinstallprompt is available, use the native prompt (HTTPS/localhost)
                if (deferredPrompt && !pwaPromptShown) {
                    await triggerInstallPrompt();
                    return;
                }

                if (pwaPromptShown) {
                    pwaStatusMessage.textContent = 'Installation already completed. App is ready to use!';
                    pwaBtnText.classList.remove('hidden');
                    pwaSpinner.classList.add('hidden');
                    pwaInstallBtn.disabled = false;
                    return;
                }

                // HTTP environment or beforeinstallprompt not ready - use Web Share API or wait for prompt
                console.log('Using HTTP fallback (Web Share API)...');
                await showHTTPFallback();
                
                pwaBtnText.classList.remove('hidden');
                pwaSpinner.classList.add('hidden');
                pwaInstallBtn.disabled = false;
            } catch (error) {
                console.error('Error in install process:', error);
                pwaStatusMessage.textContent = 'âœ— Installation error: ' + error.message;
                pwaStatusBadge.textContent = 'Error';
                pwaStatusBadge.className = 'px-2 py-1 rounded text-xs font-medium bg-red-100 text-red-700';
                
                pwaBtnText.classList.remove('hidden');
                pwaSpinner.classList.add('hidden');
                pwaInstallBtn.disabled = false;
            }
        });

        async function showHTTPFallback() {
            pwaStatusBadge.textContent = 'Installing...';
            pwaStatusBadge.className = 'px-2 py-1 rounded text-xs font-medium bg-sky-100 text-sky-600';
            pwaStatusMessage.textContent = 'â³ Opening installation dialog...';
            
            try {
                // Try Web Share API first - this works great for PWA installation
                if (navigator.share) {
                    console.log('Using Web Share API for installation');
                    const shareData = {
                        title: 'AirGit - Git Operations',
                        text: 'Install AirGit as an app on your home screen for quick access',
                        url: window.location.href
                    };
                    
                    // Show the share dialog
                    const result = await navigator.share(shareData);
                    console.log('Share action completed:', result);
                    
                    pwaStatusMessage.textContent = 'âœ“ Installation in progress! Check your home screen.';
                    pwaStatusBadge.textContent = 'âœ“ Ready';
                    pwaStatusBadge.className = 'px-2 py-1 rounded text-xs font-medium bg-sky-100 text-sky-600';
                    return;
                }
                
                // Fallback: Try to trigger beforeinstallprompt by waiting a bit longer
                console.log('Web Share API not available, waiting for beforeinstallprompt...');
                pwaStatusMessage.textContent = 'â³ Waiting for installation prompt...';
                
                // Try to wait for beforeinstallprompt with longer timeout
                const promptReceived = await waitForBeforeInstallPrompt(3000);
                
                if (promptReceived && deferredPrompt) {
                    console.log('beforeinstallprompt received after wait');
                    // Recursively call button click to use the newly received prompt
                    await triggerInstallPrompt();
                } else {
                    // Still no prompt - show helpful message
                    showInstallPromptModal();
                }
            } catch (error) {
                if (error.name === 'AbortError') {
                    console.log('User cancelled share action');
                    pwaStatusMessage.textContent = 'Installation cancelled.';
                    showReadyState();
                } else {
                    console.error('Error in HTTP fallback:', error);
                    showInstallPromptModal();
                }
            }
        }

        function waitForBeforeInstallPrompt(timeoutMs) {
            return new Promise((resolve) => {
                let resolved = false;
                const timeout = setTimeout(() => {
                    if (!resolved) {
                        resolved = true;
                        resolve(false);
                    }
                }, timeoutMs);

                // Check for prompt periodically
                const interval = setInterval(() => {
                    if (deferredPrompt) {
                        clearInterval(interval);
                        clearTimeout(timeout);
                        if (!resolved) {
                            resolved = true;
                            resolve(true);
                        }
                    }
                }, 100);
            });
        }

        async function triggerInstallPrompt() {
            if (!deferredPrompt) {
                console.log('No deferredPrompt available');
                return;
            }

            pwaInstallBtn.disabled = true;
            pwaBtnText.classList.add('hidden');
            pwaSpinner.classList.remove('hidden');

            try {
                console.log('Showing install prompt...');
                await deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                
                console.log('User choice outcome:', outcome);
                pwaPromptShown = true;
                
                if (outcome === 'accepted') {
                    showInstalledState();
                    pwaStatusMessage.textContent = 'âœ“ Installation successful! Check your home screen.';
                } else {
                    showReadyState();
                    pwaStatusMessage.textContent = 'Installation cancelled.';
                }
                
                deferredPrompt = null;
            } catch (error) {
                console.error('Error with install prompt:', error);
                pwaStatusMessage.textContent = 'âœ— Error: ' + error.message;
            } finally {
                pwaBtnText.classList.remove('hidden');
                pwaSpinner.classList.add('hidden');
                pwaInstallBtn.disabled = false;
            }
        }

        function showInstallPromptModal() {
            console.log('Showing install prompt modal');
            const isHTTP = window.location.protocol !== 'https:' && 
                          window.location.hostname !== 'localhost' && 
                          window.location.hostname !== '127.0.0.1';
            
            let instructions = `
                <div class="text-sm text-gray-700 bg-sky-50 p-4 rounded space-y-3">
                    <p class="font-semibold text-base">ðŸ“± How to Install AirGit</p>
            `;
            
            if (isHTTP) {
                instructions += `
                    <div class="bg-amber-50 border border-amber-200 rounded p-2 text-amber-800 text-xs mb-2">
                        <p class="font-semibold mb-1">ðŸ’¡ Note: Using HTTP</p>
                        <p>Full PWA features require HTTPS. However, you can still add AirGit to your home screen using your browser menu.</p>
                    </div>
                `;
            }
            
            instructions += `
                    <div class="space-y-3 text-xs">
                        <div class="bg-white p-2 rounded border border-sky-200">
                            <p class="font-semibold text-sky-700 mb-1">ðŸ¤– Android Chrome/Firefox:</p>
                            <ol class="list-decimal list-inside space-y-1 text-gray-700">
                                <li>Tap the menu icon (â‹®)</li>
                                <li>Select "Add to Home screen" or "Install app"</li>
                                <li>Confirm the app name and tap "Install"</li>
                            </ol>
                        </div>
                        <div class="bg-white p-2 rounded border border-sky-200">
                            <p class="font-semibold text-sky-700 mb-1">ðŸŽ iOS Safari:</p>
                            <ol class="list-decimal list-inside space-y-1 text-gray-700">
                                <li>Tap the Share button (â†—ï¸)</li>
                                <li>Scroll down and tap "Add to Home Screen"</li>
                                <li>Confirm the name and tap "Add"</li>
                            </ol>
                        </div>
                        <div class="bg-white p-2 rounded border border-sky-200">
                            <p class="font-semibold text-sky-700 mb-1">ðŸ’» Desktop Browsers:</p>
                            <ul class="list-disc list-inside space-y-1 text-gray-700">
                                <li>Chrome: Look for the install icon in the address bar or menu (â‹¯) â†’ "Install AirGit"</li>
                                <li>Edge: Menu (â‹¯) â†’ "Install this site as an app"</li>
                                <li>Firefox: Menu (â˜°) â†’ "Install" (if available)</li>
                            </ul>
                        </div>
                    </div>
                    <button id="install-dismiss-btn" class="w-full mt-3 bg-sky-600 hover:bg-sky-500 px-3 py-2 rounded text-white text-xs font-medium transition-colors">
                        Got it!
                    </button>
                </div>
            `;
            
            pwaStatusMessage.innerHTML = instructions;
            pwaStatusBadge.textContent = 'Ready to Install';
            pwaStatusBadge.className = 'px-2 py-1 rounded text-xs font-medium bg-sky-100 text-sky-600';
            
            // Add dismiss button functionality
            const dismissBtn = document.getElementById('install-dismiss-btn');
            if (dismissBtn) {
                dismissBtn.addEventListener('click', () => {
                    showReadyState();
                });
            }
        }

        // Initialize on page load and when settings are opened
        window.addEventListener('load', () => {
            initializePWAInstall();
        });

        initializeFromUrl();
        setInterval(loadStatus, 5000);

        // PWA Debug Information
        console.log('=== PWA Debug Info ===');
        console.log('Protocol:', window.location.protocol);
        console.log('Hostname:', window.location.hostname);
        console.log('Service Worker supported:', 'serviceWorker' in navigator);
        
        // Check if HTTPS or localhost
        const isSecure = window.location.protocol === 'https:' || window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
        console.log('PWA installable (secure context):', isSecure);

        // Check manifest loading
        fetch('/manifest.json')
            .then(r => r.json())
            .then(manifest => {
                console.log('âœ“ Manifest loaded:', manifest);
                console.log('  - Has icons:', manifest.icons?.length > 0);
                console.log('  - Icon sizes:', manifest.icons?.map(i => i.sizes).join(', '));
                console.log('  - Has start_url:', !!manifest.start_url);
                console.log('  - Display mode:', manifest.display);
                console.log('  - Scope:', manifest.scope);
            })
            .catch(e => console.error('âœ— Manifest load error:', e));

        // Check icon file
        fetch('/icon.png', { method: 'HEAD' })
            .then(r => {
                console.log('âœ“ Icon file loaded:', r.status, r.headers.get('content-type'));
            })
            .catch(e => console.error('âœ— Icon file error:', e));

        // Check service worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.getRegistrations().then(registrations => {
                console.log('Service Worker registrations:', registrations.length);
                registrations.forEach(reg => {
                    console.log('  - Scope:', reg.scope);
                    console.log('  - Active:', !!reg.active);
                    console.log('  - Installing:', !!reg.installing);
                    console.log('  - Waiting:', !!reg.waiting);
                });
            });
        }

        console.log('=== End PWA Debug ===');
    </script>
</body>
</html>
