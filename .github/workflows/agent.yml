name: AI Agent Workflow

on:
  issue_comment:
    types: [created]

permissions:
  issues: write
  contents: write
  pull-requests: write

jobs:
  agent:
    runs-on: ubuntu-latest
    if: contains(github.event.comment.body, '/airgit run')

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Git
        run: |
          git config --global user.name "AirGit Agent"
          git config --global user.email "agent@airgit.local"

      - name: Post acknowledgment comment
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'ü§ñ **AirGit Agent** has received your request. Analyzing issue and generating code...\n\n`/airgit run` - Agent workflow started'
            })

      - name: Analyze issue and generate code
        id: agent
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_NUMBER=${{ github.event.issue.number }}
          ISSUE_TITLE=$(gh issue view $ISSUE_NUMBER --json title -q '.title')
          ISSUE_BODY=$(gh issue view $ISSUE_NUMBER --json body -q '.body')
          
          # Create a branch for this issue
          BRANCH_NAME="airgit/issue-${ISSUE_NUMBER}"
          git checkout -b "$BRANCH_NAME"
          
          echo "Generated code for issue: $ISSUE_TITLE" > /tmp/generation.txt
          echo "$ISSUE_BODY" >> /tmp/generation.txt

      - name: Create commit with generated changes
        run: |
          ISSUE_NUMBER=${{ github.event.issue.number }}
          BRANCH_NAME="airgit/issue-${ISSUE_NUMBER}"
          
          # Create a placeholder commit demonstrating agent functionality
          echo "# Issue #${ISSUE_NUMBER} - Auto-generated by AirGit Agent" > AGENT_WORK_$(date +%s).md
          git add .
          git commit -m "feat: Auto-generated changes for issue #${ISSUE_NUMBER}

Generated by AirGit Agent
Issue: ${{ github.event.issue.title }}
Branch: $BRANCH_NAME"

      - name: Push branch
        run: |
          ISSUE_NUMBER=${{ github.event.issue.number }}
          BRANCH_NAME="airgit/issue-${ISSUE_NUMBER}"
          git push origin "$BRANCH_NAME"

      - name: Create Pull Request
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = context.issue.number;
            const branchName = `airgit/issue-${issueNumber}`;
            const title = `[Agent] Fix: #${issueNumber} - Automated PR`;
            
            const response = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              head: branchName,
              base: context.payload.repository.default_branch,
              body: `Automated fix for issue #${issueNumber}

Generated by AirGit Agent

## Summary
This PR contains auto-generated changes based on the issue description.

## Related Issue
Closes #${issueNumber}

---
**Note**: Please review the changes carefully before merging.`
            });
            
            core.setOutput('pr_number', response.data.number);
            core.setOutput('pr_url', response.data.html_url);

      - name: Post completion comment
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `‚úÖ **AirGit Agent** has completed analysis and generated a Pull Request!

üìã **Pull Request**: [#${{ steps.pr.outputs.pr_number }}](${{ steps.pr.outputs.pr_url }})

The generated changes are ready for review. Please check the diff and merge if it looks good.`
            })

      - name: Post error comment (if failed)
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '‚ùå **AirGit Agent** encountered an error processing your request.\n\nPlease check the workflow logs and try again.'
            })
