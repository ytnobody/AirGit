name: AI Agent Workflow
on:
  issue_comment:
    types: [created]
permissions:
  contents: write
  issues: write
  pull-requests: write
jobs:
  agent:
    runs-on: ubuntu-latest
    if: contains(github.event.comment.body, '/airgit run')
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - run: |
          git config --global user.name "AirGit"
          git config --global user.email "agent@airgit.local"
      - run: |
          git fetch origin
          BRANCH="airgit/issue-${{ github.event.issue.number }}"
          DEFAULT=$(git rev-parse --abbrev-ref origin/HEAD | cut -d/ -f2)
          git checkout "$DEFAULT"
          git pull origin "$DEFAULT"
          git branch -D "$BRANCH" 2>/dev/null || true
          git checkout -b "$BRANCH"
          mkdir -p .github/agent
          echo "# Issue #${{ github.event.issue.number }}" > ".github/agent/issue-${{ github.event.issue.number }}.md"
          git add ".github/agent/issue-${{ github.event.issue.number }}.md"
          git commit -m "feat: Solution for issue #${{ github.event.issue.number }}"
          git push -u origin "$BRANCH" --force
      - uses: actions/github-script@v7
        id: pr
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issue_number = ${{ github.event.issue.number }};
            const branch = `airgit/issue-${issue_number}`;
            const base = context.payload.repository.default_branch;
            try {
              const prs = await github.rest.pulls.list({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'all',
                head: `${context.repo.owner}:${branch}`
              });
              let pr_number, pr_url;
              if (prs.data.length > 0) {
                pr_number = prs.data[0].number;
                pr_url = prs.data[0].html_url;
              } else {
                const resp = await github.rest.pulls.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: `[Agent] Issue #${issue_number}`,
                  head: branch,
                  base: base,
                  body: `Automated solution for issue #${issue_number}`
                });
                pr_number = resp.data.number;
                pr_url = resp.data.html_url;
              }
              core.setOutput('pr_number', pr_number);
              core.setOutput('pr_url', pr_url);
            } catch (error) {
              core.setFailed(error.message);
            }
      - uses: actions/github-script@v7
        if: success()
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '✅ Done! PR: #${{ steps.pr.outputs.pr_number }}'
            })
      - uses: actions/github-script@v7
        if: failure()
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '❌ Error: Check logs'
            })
