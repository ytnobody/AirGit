name: AI Agent Workflow
on:
  issue_comment:
    types: [created]
permissions:
  contents: write
  issues: write
  pull-requests: write
jobs:
  agent:
    runs-on: ubuntu-latest
    if: contains(github.event.comment.body, '/airgit run')
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - run: |
          git config --global user.name "AirGit Agent"
          git config --global user.email "agent@airgit.local"
      
      - name: Create feature branch
        id: branch
        run: |
          ISSUE_NUM=${{ github.event.issue.number }}
          BRANCH="airgit/issue-${ISSUE_NUM}"
          echo "branch_name=$BRANCH" >> $GITHUB_OUTPUT
          echo "issue_num=$ISSUE_NUM" >> $GITHUB_OUTPUT
          
          git fetch origin
          git checkout main
          git pull origin main
          git checkout -b "$BRANCH" || git checkout "$BRANCH"
          
          mkdir -p .github/agent
          cat > ".github/agent/issue-${ISSUE_NUM}.md" << 'CONTENT'
          # Issue #ISSUE_NUM Automated Solution
          
          This is an automatically generated solution for the issue.
          CONTENT
          
          sed -i "s/ISSUE_NUM/${ISSUE_NUM}/g" ".github/agent/issue-${ISSUE_NUM}.md"
          git add ".github/agent/issue-${ISSUE_NUM}.md"
          git commit -m "feat: Automated solution for issue #${ISSUE_NUM}" || echo "No changes"
          git push -u origin "$BRANCH" --force
      
      - name: Create Pull Request
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const issue_number = ${{ github.event.issue.number }};
            const branch = `airgit/issue-${issue_number}`;
            
            try {
              const prs = await github.rest.pulls.list({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open',
                head: `${context.repo.owner}:${branch}`
              });
              
              let pr;
              if (prs.data.length > 0) {
                pr = prs.data[0];
                console.log(`Using existing PR #${pr.number}`);
              } else {
                const created = await github.rest.pulls.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: `[Agent] Issue #${issue_number}`,
                  head: branch,
                  base: 'main',
                  body: `Automated solution for issue #${issue_number}\n\nGenerated by AirGit Agent`
                });
                pr = created.data;
                console.log(`Created PR #${pr.number}`);
              }
              
              core.setOutput('pr_number', pr.number);
              core.setOutput('pr_url', pr.html_url);
            } catch (error) {
              console.error('Error:', error.message);
              core.setFailed(error.message);
            }
      
      - name: Post success comment
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `✅ PR created: [#${{ steps.pr.outputs.pr_number }}](${{ steps.pr.outputs.pr_url }})`
            })
      
      - name: Post error comment
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '❌ Error: Check workflow logs'
            })
